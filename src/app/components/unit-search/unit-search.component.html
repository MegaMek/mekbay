@let gunnery = this.filtersService.pilotGunnerySkill();
@let piloting = this.filtersService.pilotPilotingSkill();

<div class="search-overlay overlay-backdrop" [class.expanded]="this.expandedView()"
    [hidden]="!this.filtersService.isDataReady() || !overlayVisible()" (click)="onOverlayClick()">
</div>

<div class="searchbar-container" [class.expanded]="this.expandedView()">
    @if (buttonOnly() && !this.expandedView()) {
    <button type="button" class="bt-button expand-btn square-large" (click)="toggleExpandedView()">
        <svg stroke="currentColor" width="24px" height="24px" viewBox="0 0 24 24" fill="none"
            xmlns="http://www.w3.org/2000/svg">
            <path
                d="M15.8053 15.8013L21 21M18 10.5C18 14.6421 14.6421 18 10.5 18C6.35786 18 3 14.6421 3 10.5C3 6.35786 6.35786 3 10.5 3C14.6421 3 18 6.35786 18 10.5Z"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
    </button>
    } @else {
    <button type="button" class="bt-button expand-btn square" (click)="toggleExpandedView()"
        [title]="this.expandedView() ? 'Collapse View' : 'Expand View'"
        [attr.aria-label]="this.expandedView() ? 'Collapse View' : 'Expand View'">
        @if (this.expandedView()) {
        <svg width="24px" height="24px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
            focusable="false" aria-hidden="true" role="img">
            <path d="M4 14H10M10 14V20M10 14L3 21M20 10H14M14 10V4M14 10L21 3" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
        </svg>
        } @else {
        <svg width="24px" height="24px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
            focusable="false" aria-hidden="true" role="img">
            <path d="M14 10L21 3M21 3H15M21 3V9M10 14L3 21M3 21H9M3 21L3 15" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
        </svg>
        }
    </button>
    <!-- Adv button on left when filters are on left side -->
    @if (this.expandedView() && this.filtersOnLeft()) {
    <button #advBtn class="bt-button adv-btn square" [class.active]="isAdvActive()"
        [disabled]="!this.filtersService.isDataReady()" (click)="toggleAdv()" title="Advanced Search" type="button">
        <svg width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
            stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"
            focusable="false">
            <path d="M4 4h16l-6 8v5l-4 3v-8z" />
        </svg>
    </button>
    }
    <div class="searchbar-input-container">
        <syntax-input #syntaxInput [value]="this.filtersService.searchText()" [tokens]="highlightTokens()"
            [placeholder]="this.filtersService.isDataReady() ? 'Search units...' : 'Loading data...'"
            [disabled]="!this.filtersService.isDataReady()" [showClear]="this.filtersService.searchText().length > 0"
            (valueChange)="setSearch($event)" (cleared)="clearSearch()" (focused)="focused.set(true)"
            id="unit-search-input" />
    </div>
    <button #favBtn type="button" class="bt-button favorites-btn square" (click)="openFavorites($event)"
        [title]="'Favorites'" aria-label="Favorites">
        <svg width="24px" fill="currentColor" height="24px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path
                d="M23.632 9.201a.628.628 0 0 1-.22.678l-5.726 4.96 1.727 7.394a.606.606 0 0 1-.935.676l-6.503-3.953-6.503 3.953a.713.713 0 0 1-.374.112.57.57 0 0 1-.34-.109.629.629 0 0 1-.222-.679l1.729-7.393L.539 9.879A.607.607 0 0 1 .897 8.78l7.536-.635 2.965-7.083a.62.62 0 0 1 1.155.001l2.965 7.082 7.536.635a.63.63 0 0 1 .578.42z" />
        </svg>
    </button>
    @if (this.expandedView()) {
    <button type="button" class="bt-button semantic-guide-btn square" (click)="openSemanticGuide($event)"
        [title]="'Semantic Guide'" aria-label="Semantic Guide">
        <svg fill="currentColor" width="24px" height="24px" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg">
            <path
                d="M512 64a448 448 0 1 1 0 896 448 448 0 0 1 0-896zm23.744 191.488c-52.096 0-92.928 14.784-123.2 44.352-30.976 29.568-45.76 70.4-45.76 122.496h80.256c0-29.568 5.632-52.8 17.6-68.992 13.376-19.712 35.2-28.864 66.176-28.864 23.936 0 42.944 6.336 56.32 19.712 12.672 13.376 19.712 31.68 19.712 54.912 0 17.6-6.336 34.496-19.008 49.984l-8.448 9.856c-45.76 40.832-73.216 70.4-82.368 89.408-9.856 19.008-14.08 42.24-14.08 68.992v9.856h80.96v-9.856c0-16.896 3.52-31.68 10.56-45.76 6.336-12.672 15.488-24.64 28.16-35.2 33.792-29.568 54.208-48.576 60.544-55.616 16.896-22.528 26.048-51.392 26.048-86.592 0-42.944-14.08-76.736-42.24-101.376-28.16-25.344-65.472-37.312-111.232-37.312zm-12.672 406.208a54.272 54.272 0 0 0-38.72 14.784 49.408 49.408 0 0 0-15.488 38.016c0 15.488 4.928 28.16 15.488 38.016A54.848 54.848 0 0 0 523.072 768c15.488 0 28.16-4.928 38.72-14.784a51.52 51.52 0 0 0 16.192-38.72 51.968 51.968 0 0 0-15.488-38.016 55.936 55.936 0 0 0-39.424-14.784z" />
        </svg>
    </button>
    }
    <!-- Adv button on right when filters are on right side (default) -->
    @if (!this.expandedView() || !this.filtersOnLeft()) {
    <button #advBtn class="bt-button adv-btn square" [class.active]="isAdvActive()"
        [disabled]="!this.filtersService.isDataReady()" (click)="toggleAdv()" title="Advanced Search" type="button">
        <svg width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
            stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"
            focusable="false">
            <path d="M4 4h16l-6 8v5l-4 3v-8z" />
        </svg>
    </button>
    }
    }
</div>

<!-- Results Container -->
<div #resultsContainer class="results-container"
    [class.expanded]="this.expandedView()"
    [class.with-details-panel]="showInlinePanel()"
    [hidden]="!this.filtersService.isDataReady() || !resultsVisible()"
    [style.top]="this.expandedView() ? expandedWrapperStyle().top : resultsDropdownStyle().top"
    [style.left]="this.expandedView() ? expandedWrapperStyle().left : null"
    [style.right]="this.expandedView() ? expandedWrapperStyle().right : null"
    [style.bottom]="this.expandedView() ? expandedWrapperStyle().bottom : null"
    [style.width]="this.expandedView() ? null : resultsDropdownStyle().width"
    [style.height]="this.expandedView() ? null : resultsDropdownStyle().height"
    [style.flex-direction]="this.expandedView() ? expandedWrapperStyle().flexDirection : null">

    <!-- Inline Details Panel (visible when screen permits in expanded view) -->
    @if (showInlinePanel()) {
    <unit-details-panel class="inline-details-panel framed-borders" [unit]="inlinePanelUnit()"
        [gunnerySkill]="this.filtersService.pilotGunnerySkill()"
        [pilotingSkill]="this.filtersService.pilotPilotingSkill()"
        [hasPrev]="inlinePanelHasPrev()"
        [hasNext]="inlinePanelHasNext()"
        (add)="onInlinePanelAdd($event)"
        (prev)="onInlinePanelPrev()"
        (next)="onInlinePanelNext()">
    </unit-details-panel>
    }

    <div class="results-dropdown framed-borders" [class.expanded]="this.expandedView()">
        <div class="results-dropdown-content">
            @if (this.filtersService.filteredUnits().length > 0) {
            <!-- Table Header for AS Table View (expanded only) -->
            @if (this.expandedView() && gameService.isAlphaStrike()) {
            <div class="as-table-header">
                <div class="as-th as-th-icon"></div>
                <div class="as-th as-th-name">Name</div>
                <div class="as-th as-th-type">Type</div>
                <div class="as-th as-th-role">Role</div>
                <div class="as-th as-th-pv">PV</div>
                <div class="as-th as-th-sz">SZ</div>
                <div class="as-th as-th-mv">MV</div>
                <div class="as-th as-th-tmm">TMM</div>
                <div class="as-th as-th-dmg">S/M/L</div>
                <div class="as-th as-th-arm">A</div>
                <div class="as-th as-th-str">S</div>
                <div class="as-th as-th-ov">OV</div>
                <div class="as-th as-th-specials">Special</div>
                <div class="as-th as-th-tags">Tags</div>
            </div>
            }

            <!-- Single Virtual Scroll Viewport -->
            <cdk-virtual-scroll-viewport class="results-dropdown-viewport" [itemSize]="this.itemSize()"
                [style.--item-size.px]="this.itemSize()" minBufferPx="900" maxBufferPx="1350" tabindex="0">
                <div class="results-dropdown-item unit-card"
                    *cdkVirtualFor="let unit of this.filtersService.filteredUnits(); let i = index; trackBy: trackByUnitId"
                    [class.active]="activeIndex() === i"
                    [class.selected]="isUnitSelected(unit)"
                    [class.panel-selected]="showInlinePanel() && inlinePanelUnit()?.name === unit.name"
                    (pointerenter)="activeIndex.set(i)"
                    longPress
                    (shortPress)="onUnitCardClick(unit, $event)"
                    (longPress)="multiSelectUnit(unit)">

                    @if (this.expandedView()) {
                        <!-- Expanded View Cards (DON'T put it into a ngTemplateOutlet, it leaks in virtual scroll!!) -->
                        @if (gameService.isAlphaStrike()) {
                        <!-- AS Expanded Card -->
                        <div class="expanded-unit-card as-card-view">
                            <div class="expanded-header">
                                <div class="expanded-image">
                                    <unit-icon [unit]="unit" [size]="56"></unit-icon>
                                </div>
                                <div class="expanded-title">
                                    <div class="expanded-model" [innerHTML]="highlight(unit.model)"></div>
                                    <div class="expanded-chassis" [innerHTML]="highlight(unit.chassis)"></div>
                                </div>
                                <div class="expanded-subtitle">
                                    @if (unit.role && unit.role !== 'None') {
                                    <div class="subtitle-line role">{{ unit.role }}</div>
                                    }
                                    <div class="subtitle-line">
                                        <span>{{ unit.as.TP }}</span>
                                        <span> • {{ unit.weightClass }}</span>
                                    </div>
                                    <div class="subtitle-line">
                                        <unit-tags [unit]="unit" mode="full" (tagClick)="onAddTag($event)" />
                                    </div>
                                </div>
                            </div>
                            <div class="expanded-content as-view">
                                <div class="expanded-basic">
                                    <div class="expanded-basic-info">
                                        <div class="info-item">
                                            <span class="info-label muted">PV:</span>
                                            <span class="info-value" [class.sort-slot]="this.filtersService.selectedSort() === 'as.PV'">{{ unit.as.PV | adjustedPV:gunnery | formatNumber:true:false }}</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label muted">Size:</span>
                                            <span class="info-value" [class.sort-slot]="this.filtersService.selectedSort() === 'as.SZ'">{{ unit.as.SZ }}</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label muted">TMM:</span>
                                            <span class="info-value" [class.sort-slot]="this.filtersService.selectedSort() === 'as.TMM'">{{ unit.as.TMM }}</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label muted">Movement:</span>
                                            <span class="info-value">{{ formatASMovement(unit) }}</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label muted">Armor:</span>
                                            <span class="info-value">{{ unit.as.Arm }}</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label muted">Structure:</span>
                                            <span class="info-value">{{ unit.as.Str }}</span>
                                        </div>
                                        @if (!unit.as.usesArcs) {
                                        <div class="info-item">
                                            <span class="info-label muted">Damage:</span>
                                            <span class="info-value">{{ unit.as.dmg.dmgS }}/{{ unit.as.dmg.dmgM }}/{{ unit.as.dmg.dmgL }}</span>
                                        </div>
                                        }
                                        @if (unit.as.usesOV) {
                                        <div class="info-item">
                                            <span class="info-label muted">Overheat:</span>
                                            <span class="info-value">{{ unit.as.OV }}</span>
                                        </div>
                                        }
                                        @if (unit.as.usesTh) {
                                        <div class="info-item">
                                            <span class="info-label muted">Thrust:</span>
                                            <span class="info-value">{{ unit.as.Th }}</span>
                                        </div>
                                        }
                                        <div class="info-item">
                                            <span class="info-label muted">Intro Year: </span>
                                            <span class="info-value" [class.sort-slot]="this.filtersService.selectedSort() === 'year'">{{ unit.year }} @if(unit._era?.img) { <img [src]="unit._era.img" class="era-icon" [alt]="unit._era?.name" [title]="unit._era?.name" /> }</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label muted">Tech:</span>
                                            <span class="info-value" [class.sort-slot]="this.filtersService.selectedSort() === 'techBase'">{{ unit.techBase }}</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label muted">Tons:</span>
                                            <span class="info-value" [class.sort-slot]="this.filtersService.selectedSort() === 'tons'">{{ unit.tons | formatTons }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="expanded-right">
                                    @if (unit.as.specials && unit.as.specials.length > 0) {
                                    <div class="components-header">Special:</div>
                                    <div class="expanded-specials">
                                        <div class="specials-pills">
                                            @for (special of unit.as.specials; let last = $last; let i = $index; track i) {
                                            <span class="special-pill" (click)="showAbilityInfoDialog(special); $event.stopPropagation()" title="Click for details">{{ special }}</span>
                                            }
                                        </div>
                                    </div>
                                    }
                                </div>
                            </div>
                        </div>
                        <!-- AS Table Row View -->
                        <div class="as-table-row">
                            <div class="as-td as-td-icon"><unit-icon [unit]="unit" [size]="36"></unit-icon></div>
                            <div class="as-td as-td-name">
                                <span class="as-td-model" [innerHTML]="highlight(unit.model)"></span>
                                <span class="as-td-chassis" [innerHTML]="highlight(unit.chassis)"></span>
                            </div>
                            <div class="as-td as-td-type">{{ unit.as.TP }}</div>
                            <div class="as-td as-td-role">{{ unit.role !== 'None' ? unit.role : '' }}</div>
                            <div class="as-td as-td-pv" [class.sort-slot]="this.filtersService.selectedSort() === 'as.PV'">{{ unit.as.PV | adjustedPV:gunnery | formatNumber:true:false }}</div>
                            <div class="as-td as-td-sz" [class.sort-slot]="this.filtersService.selectedSort() === 'as.SZ'">{{ unit.as.SZ }}</div>
                            <div class="as-td as-td-mv">{{ formatASMovement(unit) }}</div>
                            <div class="as-td as-td-tmm" [class.sort-slot]="this.filtersService.selectedSort() === 'as.TMM'">{{ unit.as.TMM }}</div>
                            <div class="as-td as-td-dmg">@if (!unit.as.usesArcs) { {{ unit.as.dmg.dmgS }}/{{ unit.as.dmg.dmgM }}/{{ unit.as.dmg.dmgL }} }</div>
                            <div class="as-td as-td-arm">{{ unit.as.Arm }}</div>
                            <div class="as-td as-td-str">{{ unit.as.Str }}</div>
                            <div class="as-td as-td-ov">@if (unit.as.usesOV) { {{ unit.as.OV }} }</div>
                            <div class="as-td as-td-specials">
                                @for (special of unit.as.specials; let i = $index; track i) {
                                <span class="special-pill" (click)="showAbilityInfoDialog(special); $event.stopPropagation()" title="Click for details">{{ special }}</span>
                                }
                            </div>
                            <div class="as-td as-td-tags">
                                <unit-tags [unit]="unit" mode="full" size="small" (tagClick)="onAddTag($event)" />
                            </div>
                        </div>
                        } @else {
                        <!-- BT Expanded Card -->
                        <div class="expanded-unit-card">
                            <div class="expanded-header">
                                <div class="expanded-image">
                                    <unit-icon [unit]="unit" [size]="56"></unit-icon>
                                </div>
                                <div class="expanded-title">
                                    <div class="expanded-model" [innerHTML]="highlight(unit.model)"></div>
                                    <div class="expanded-chassis" [innerHTML]="highlight(unit.chassis)"></div>
                                </div>
                                <div class="expanded-subtitle">
                                    @if (unit.role && unit.role !== 'None') {
                                    <div class="subtitle-line role">{{ unit.role }}</div>
                                    }
                                    <div class="subtitle-line">
                                        <span>{{ unit.type }}@if(unit.subtype && unit.subtype !== unit.type){<span> - {{ unit.subtype }}</span>}</span>
                                        <span> • {{ unit.weightClass }}</span>
                                    </div>
                                    <div class="subtitle-line">
                                        <unit-tags [unit]="unit" mode="full" (tagClick)="onAddTag($event)" />
                                    </div>
                                </div>
                            </div>
                            <div class="expanded-content">
                                <div class="expanded-basic">
                                    <div class="expanded-basic-info">
                                        <div class="info-item">
                                            <span class="info-label muted">BV:</span>
                                            <span class="info-value" [class.sort-slot]="this.filtersService.selectedSort() === 'bv'">{{ unit | adjustedBV:gunnery:piloting | formatNumber:true:false }}</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label muted">Tons:</span>
                                            <span class="info-value" [class.sort-slot]="this.filtersService.selectedSort() === 'tons'">{{ unit.tons | formatTons }}</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label muted">Rules:</span>
                                            <span class="info-value" [class.sort-slot]="this.filtersService.selectedSort() === 'level'">{{ unit.level }}</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label muted">Intro Year: </span>
                                            <span class="info-value" [class.sort-slot]="this.filtersService.selectedSort() === 'year'">{{ unit.year }} @if(unit._era?.img) { <img [src]="unit._era.img" class="era-icon" [alt]="unit._era?.name" [title]="unit._era?.name" /> }</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label muted">Tech:</span>
                                            <span class="info-value" [class.sort-slot]="this.filtersService.selectedSort() === 'techBase'">{{ unit.techBase }}</span>
                                        </div>
                                        @if (unit.cost) {
                                        <div class="info-item">
                                            <span class="info-label muted">C-Bill:</span>
                                            <span class="info-value">{{ unit.cost | formatNumber:true:false }}</span>
                                        </div>
                                        }
                                        @if (unit.armorType) {
                                        <div class="info-item">
                                            <span class="info-label muted">Armor:</span>
                                            <span class="info-value">{{ unit.armorType }}</span>
                                        </div>
                                        }
                                        @if (unit.structureType) {
                                        <div class="info-item">
                                            <span class="info-label muted">Structure:</span>
                                            <span class="info-value">{{ unit.structureType }}</span>
                                        </div>
                                        }
                                        @if (unit.moveType) {
                                        <div class="info-item">
                                            <span class="info-label muted">Motive:</span>
                                            <span class="info-value">{{ unit.moveType }}</span>
                                        </div>
                                        }
                                        @if (unit.engine) {
                                        <div class="info-item">
                                            <span class="info-label muted">Engine:</span>
                                            <span class="info-value">@if(unit.engineRating){ {{ unit.engineRating }} }{{ unit.engine }}</span>
                                        </div>
                                        }
                                        @if (unit.c3) {
                                        <div class="info-item">
                                            <span class="info-label muted">Network:</span>
                                            <span class="info-value">{{ unit.c3 }}</span>
                                        </div>
                                        }
                                        @if (unit.walk) {
                                        <div class="info-item">
                                            <span class="info-label muted">Movement:</span>
                                            <span class="info-value">{{ unit.walk }} / {{ unit.run }} @if(unit.run2 != unit.run){ [{{ unit.run2 }}]} @if(unit.jump){ / {{ unit.jump }} } @if (unit.umu) { / {{ unit.umu }}}</span>
                                        </div>
                                        }
                                    </div>
                                </div>
                                <div class="expanded-stats">
                                    <div class="stat-bars-columns">
                                        @if((unit | statBarSpecs); as specsList) {
                                        @for (spec of specsList; let i = $index; track i) {
                                        <div class="stat-bar-row" [tooltip]="spec.description ?? null">
                                            <div class="stat-bar">
                                                <div class="stat-bar-fill" [style.width.%]="spec.percent"></div>
                                            </div>
                                            <span class="stat-label">{{ spec.label }}</span>
                                            <span class="stat-value">{{ spec.valueText ?? spec.value }}</span>
                                        </div>
                                        }
                                        }
                                    </div>
                                </div>
                                <div class="expanded-right">
                                    @if ((unit.comp | expandedComponents); as componentsList) {
                                    @if (componentsList.length > 0) {
                                    <div class="components-header">Equipment</div>
                                    <div class="expanded-components">
                                        <div class="components-pills">
                                            @for (comp of componentsList; let last = $last; let i = $index; track i) {
                                            <unit-component-item [unit]="unit" [comp]="comp" displayStyle="tiny"></unit-component-item>
                                            }
                                        </div>
                                    </div>
                                    }
                                    }
                                    @if ((unit.comp | filterAmmo); as ammoList) {
                                    @if (ammoList.length > 0) {
                                    <div class="ammo-list">
                                        <span class="info-label muted">Ammo: </span>
                                        @for (comp of ammoList; let last = $last; let i = $index; track i) {
                                        <unit-component-item [unit]="unit" [comp]="comp" displayStyle="text"></unit-component-item>@if(!last){<span>, </span>}
                                        }
                                    </div>
                                    }
                                    }
                                </div>
                            </div>
                        </div>
                        }
                    } @else {
                        <!-- Compact View Card (DON'T put it into a ngTemplateOutlet, it leaks in virtual scroll!!) -->
                        <unit-icon [unit]="unit" [size]="48"></unit-icon>
                        <div class="unit-data-container">
                            <div class="secondary-info">
                                <div class="model" [innerHTML]="highlight(unit.model)"></div>
                                @if (unit.role && (unit.role !== 'None')) {
                                <div class="role" [class.sort-slot]="this.filtersService.selectedSort() === 'role'">{{ unit.role }}</div>
                                }
                            </div>
                            <div class="primary-info">
                                <div class="chassis" [innerHTML]="highlight(unit.chassis)"></div>
                            </div>
                            <div class="third-info">
                                <div class="info-area">
                                    @if (gameService.isAlphaStrike()) {
                                    <div class="info-slot centered slim" [class.sort-slot]="this.filtersService.selectedSort() === 'as.PV'">
                                        <span class="value">PV: {{ unit.as.PV | adjustedPV:gunnery | formatNumber:true:true }}</span>
                                    </div>
                                    <div class="info-slot centered slim" [class.sort-slot]="this.filtersService.selectedSort() === 'as.SZ'">
                                        <span class="value">SZ: {{ unit.as.SZ }}</span>
                                    </div>
                                    <div class="info-slot centered slim" [class.sort-slot]="this.filtersService.selectedSort() === 'as.TMM'">
                                        <span class="value">TMM: {{ unit.as.TMM }}</span>
                                    </div>
                                    } @else {
                                    <div class="info-slot numeric" [class.sort-slot]="this.filtersService.selectedSort() === 'bv'">
                                        <span class="value">BV: {{ unit | adjustedBV:gunnery:piloting | formatNumber:true:true }}</span>
                                    </div>
                                    <div class="info-slot numeric" [class.sort-slot]="this.filtersService.selectedSort() === 'tons'">
                                        <span class="value">{{ unit.tons | formatTons }}</span>
                                        <img src="/images/weight.svg" class="icon" alt="Tonnage">
                                    </div>
                                    }
                                    <div class="info-slot" [class.sort-slot]="this.filtersService.selectedSort() === 'year'">
                                        <span class="value">{{ unit.year }}</span>
                                        @if (unit._era?.img) {
                                        <img [src]="unit._era?.img" class="icon era-icon" alt="Era" [title]="unit._era?.name" />
                                        }
                                    </div>
                                    @if (getSortSlot(unit); as slot) {
                                    <div class="info-slot sort-slot" [class.numeric]="slot.numeric && slot.img">
                                        <span class="value">
                                            @if(slot.label) { {{ slot.label }}: } {{ slot.value }}
                                        </span>
                                        @if (slot.img) {<img [src]="slot.img" class="icon" [alt]="slot.alt">}
                                    </div>
                                    }
                                </div>
                                <span class="spanner"></span>
                                <unit-tags [unit]="unit" mode="compact" (tagClick)="onAddTag($event)" />
                            </div>
                        </div>
                    }
                </div>
            </cdk-virtual-scroll-viewport>

            @if (this.selectedUnits().size > 0) {
                <div class="selection-footer">
                    <div class="selected-count">{{ this.selectedUnits().size }} units selected</div>
                    <span class="spanner"></span>
                    <button [disabled]="this.forceBuilderService.readOnlyForce()" type="button" class="bt-button"
                        (click)="addSelectedUnits()">ADD TO FORCE</button>
                    <button type="button" class="bt-button" (click)="selectAll()">SELECT ALL</button>
                    <button type="button" class="bt-button" (click)="clearSelection()">CLEAR</button>
                </div>
            }
            @if (this.filtersService.filteredUnits().length > 0) {
                <div class="results-footer">
                    <div class="results-count">{{ this.filtersService.filteredUnits().length }} result{{
                        this.filtersService.filteredUnits().length === 1 ? '' : 's' }}</div>
                    <span class="spanner"></span>
                    <div class="results-sort">
                        <select class="bt-input sort-select"
                            (change)="this.filtersService.setSortOrder($any($event.target).value)">
                            @for (opt of SORT_OPTIONS; let i = $index; track i) {
                            @if (!opt.gameSystem || opt.gameSystem === this.gameSystem()) {
                            <option [value]="opt.key" [selected]="opt.key === this.filtersService.selectedSort()">{{ opt.label }}</option>
                            }
                            }
                        </select><button type="button" class="bt-button sort-direction-btn"
                            (click)="this.filtersService.setSortDirection(this.filtersService.selectedSortDirection() === 'asc' ? 'desc' : 'asc')"
                            [title]="this.filtersService.selectedSortDirection() === 'asc' ? 'Ascending' : 'Descending'"
                            [attr.aria-label]="this.filtersService.selectedSortDirection() === 'asc' ? 'Ascending' : 'Descending'">
                            @if (this.filtersService.selectedSortDirection() === 'asc') {
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" focusable="false"
                                aria-hidden="true" role="img">
                                <path d="M4 16L13 16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                                <path d="M6 11H13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                                <path d="M8 6L13 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                                <path d="M17 4L17 20L20 16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                            } @else {
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" focusable="false"
                                aria-hidden="true" role="img">
                                <path d="M4 8H13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                                <path d="M6 13H13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                                <path d="M8 18H13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                                <path d="M17 20V4L20 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                            }
                        </button>
                    </div>
                    <button class="bt-button square share-btn" (click)="openShareSearch($event)" title="Share Search Results">
                        <svg width="24px" height="24px" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" clip-rule="evenodd"
                                d="M13.803 5.33333C13.803 3.49238 15.3022 2 17.1515 2C19.0008 2 20.5 3.49238 20.5 5.33333C20.5 7.17428 19.0008 8.66667 17.1515 8.66667C16.2177 8.66667 15.3738 8.28596 14.7671 7.67347L10.1317 10.8295C10.1745 11.0425 10.197 11.2625 10.197 11.4872C10.197 11.9322 10.109 12.3576 9.94959 12.7464L15.0323 16.0858C15.6092 15.6161 16.3473 15.3333 17.1515 15.3333C19.0008 15.3333 20.5 16.8257 20.5 18.6667C20.5 20.5076 19.0008 22 17.1515 22C15.3022 22 13.803 20.5076 13.803 18.6667C13.803 18.1845 13.9062 17.7255 14.0917 17.3111L9.05007 13.9987C8.46196 14.5098 7.6916 14.8205 6.84848 14.8205C4.99917 14.8205 3.5 13.3281 3.5 11.4872C3.5 9.64623 4.99917 8.15385 6.84848 8.15385C7.9119 8.15385 8.85853 8.64725 9.47145 9.41518L13.9639 6.35642C13.8594 6.03359 13.803 5.6896 13.803 5.33333Z" />
                        </svg>
                    </button>
                </div>          
            }
            } @else {
            <div class="results-dropdown-item no-results">No results</div>
            }
        </div>
    </div>
</div>

@if (this.expandedView() && this.advPanelDocked()) {
<div class="adv-panel-drag-handle" [class.left]="filtersOnLeft()" (pointerdown)="onAdvPanelDragStart($event)" (click)="$event.stopPropagation();"
    (contextmenu)="$event.stopPropagation()" 
    [style.right.px]="filtersOnLeft() ? null : (this.advPanelUserColumns() === 2 ? 602 : 302)"
    [style.left.px]="filtersOnLeft() ? (this.advPanelUserColumns() === 2 ? 602 : 302) : null"
    title="Drag to resize advanced filter panel" aria-label="Drag to resize advanced filter panel">
    <div class="drag-bar"></div>
</div>
}
<div #advPanel class="adv-panel framed-borders has-shadow" [hidden]="!advOpen()"
    [style.left]="advPanelStyle().left"
    [style.top]="advPanelStyle().top"
    [style.width]="advPanelStyle().width"
    [style.height]="advPanelStyle().height"
    [class.docked]="advPanelDocked()" [class.docked-left]="advPanelDocked() && filtersOnLeft()">
    <div class="adv-panel-header" [style.gridTemplateColumns]="advPanelStyle().columnsCount === 2 ? '1fr 1fr' : '1fr'">
        <button (click)="clearAdvFilters()" type="button" class="bt-button clear-btn">RESET FILTERS</button>
        <div class="pilot-skills-section framed-borders">
            <div class="pilot-skills-controls">
                @if (gameService.isAlphaStrike()) {
                <div class="skill-control">
                    <label for="gunnery-skill" (click)="openSelect($event, gunnerySelect)">Pilot Skill:</label>
                    <select #gunnerySelect id="gunnery-skill" class="bt-input skill-select"
                        [class.active]="gunnery != 4" [value]="gunnery"
                        (change)="setPilotSkill('gunnery', +$any($event.target).value)">
                        @for (n of [0,1,2,3,4,5,6,7,8]; let i = $index; track i) {
                        <option [value]="n" [selected]="n === gunnery">{{ n }}</option>
                        }

                    </select>
                </div>
                } @else {
                <div class="skill-control">
                    <label for="gunnery-skill" (click)="openSelect($event, gunnerySelect)">Gunnery:</label>
                    <select #gunnerySelect id="gunnery-skill" class="bt-input skill-select"
                        [class.active]="gunnery != 4" [value]="gunnery"
                        (change)="setPilotSkill('gunnery', +$any($event.target).value)">
                        @for (n of [0,1,2,3,4,5,6,7,8]; let i = $index; track i) {
                        <option [value]="n" [selected]="n === gunnery">{{ n }}</option>
                        }

                    </select>
                </div>
                <div class="skill-control">
                    <label for="piloting-skill" (click)="openSelect($event, pilotingSelect)">Piloting:</label>
                    <select #pilotingSelect id="piloting-skill" class="bt-input skill-select"
                        [class.active]="piloting != 5" [value]="piloting"
                        (change)="setPilotSkill('piloting', +$any($event.target).value)">
                        @for (n of [0,1,2,3,4,5,6,7,8]; let i = $index; track i) {
                        <option [value]="n" [selected]="n === piloting">{{ n }}</option>
                        }
                    </select>
                </div>
                }
            </div>
        </div>
    </div>
    <div class="adv-panel-content" [style.gridTemplateColumns]="advPanelStyle().columnsCount === 2 ? '1fr 1fr' : '1fr'">
        @if (isComplexQuery()) {
        <!-- Complex query: show semantic guide as sidebar -->
        <div class="complex-query-guide">
            <div class="complex-query-notice">
                <span class="notice-text">Filters controlled by search query</span>
            </div>
            <semantic-guide [compact]="true" />
        </div>
        } @else {
        <!-- Dropdown filters -->
        @for (conf of dropdownFilters(); let i = $index; track i) {
          @let filterOpts = $any(filtersService.advOptions()[conf.key]);
          <div class="filter-row" [class.semantic-only]="filterOpts?.semanticOnly">
            <multi-select-dropdown class="dropdown"
                [label]="filterOpts?.label ?? ''"
                [options]="filterOpts?.options ?? []"
                [selected]="filterOpts?.value ?? []"
                [multistate]="conf.multistate ?? false"
                [countable]="conf.countable ?? false" 
                [semanticOnly]="filterOpts?.semanticOnly ?? false"
                [displayText]="filterOpts?.displayText"
                [displayItems]="filterOpts?.displayItems"
                (selectionChange)="setAdvFilter(conf.key, $event)">
            </multi-select-dropdown>
          </div>
        }
        <!-- Range Filters -->
        @for (conf of rangeFilters(); let i = $index; track i) {
          @let rangeOpts = $any(filtersService.advOptions()[conf.key]);
          <div class="filter-row" [class.semantic-only]="rangeOpts?.semanticOnly">
            <div class="range">
                <label class="range-label" [class.disabled]="rangeOpts?.semanticOnly"
                    (click)="!rangeOpts?.semanticOnly && openRangeValueDialog(conf.key, rangeOpts?.value, rangeOpts?.options)">{{
                    rangeOpts?.label }}
                    @if (rangeOpts?.displayText) {
                    <span class="effective-range" title="Effective range after exclusions">
                        ✓ {{ rangeOpts?.displayText }}
                    </span>
                    } @else {
                    <span class="range-values">
                        (<span class="range-value-min">{{ rangeOpts?.value?.[0] | formatNumber:false:true }}</span>~<span
                            class="range-value-max">{{ rangeOpts?.value?.[1] | formatNumber:false:true }}</span>)
                    </span>
                    }
                </label>
                <range-slider [min]="rangeOpts?.totalRange?.[0] ?? 0"
                    [max]="rangeOpts?.totalRange?.[1] ?? 100"
                    [value]="rangeOpts?.value"
                    [availableRange]="rangeOpts?.options"
                    [interacted]="rangeOpts?.interacted ?? false"
                    [curve]="conf.curve ?? 1" [stepSize]="conf.stepSize ?? 1"
                    [disabled]="rangeOpts?.semanticOnly ?? false"
                    [excludeRanges]="rangeOpts?.excludeRanges"
                    [includeRanges]="rangeOpts?.includeRanges"
                    (valueChange)="setAdvFilter(conf.key, $event)">
                </range-slider>
            </div>
          </div>
        }
        }
    </div>
</div>

<!-- ======================== TEMPLATES ======================== -->

<!-- Compact Card Template (non-expanded view) -->
<ng-template #compactCardTpl let-unit="unit" let-gunnery="gunnery" let-piloting="piloting">
    <unit-icon [unit]="unit" [size]="48"></unit-icon>
    <div class="unit-data-container">
        <div class="secondary-info">
            <div class="model" [innerHTML]="highlight(unit.model)"></div>
            @if (unit.role && (unit.role !== 'None')) {
            <div class="role" [class.sort-slot]="this.filtersService.selectedSort() === 'role'">{{ unit.role }}</div>
            }
        </div>
        <div class="primary-info">
            <div class="chassis" [innerHTML]="highlight(unit.chassis)"></div>
        </div>
        <div class="third-info">
            <div class="info-area">
                @if (gameService.isAlphaStrike()) {
                <div class="info-slot centered slim" [class.sort-slot]="this.filtersService.selectedSort() === 'as.PV'">
                    <span class="value">PV: {{ unit.as.PV | adjustedPV:gunnery | formatNumber:true:true }}</span>
                </div>
                <div class="info-slot centered slim" [class.sort-slot]="this.filtersService.selectedSort() === 'as.SZ'">
                    <span class="value">SZ: {{ unit.as.SZ }}</span>
                </div>
                <div class="info-slot centered slim" [class.sort-slot]="this.filtersService.selectedSort() === 'as.TMM'">
                    <span class="value">TMM: {{ unit.as.TMM }}</span>
                </div>
                } @else {
                <div class="info-slot numeric" [class.sort-slot]="this.filtersService.selectedSort() === 'bv'">
                    <span class="value">BV: {{ unit | adjustedBV:gunnery:piloting | formatNumber:true:true }}</span>
                </div>
                <div class="info-slot numeric" [class.sort-slot]="this.filtersService.selectedSort() === 'tons'">
                    <span class="value">{{ unit.tons | formatTons }}</span>
                    <img src="/images/weight.svg" class="icon" alt="Tonnage">
                </div>
                }
                <div class="info-slot" [class.sort-slot]="this.filtersService.selectedSort() === 'year'">
                    <span class="value">{{ unit.year }}</span>
                    @if (unit._era?.img) {
                    <img [src]="unit._era?.img" class="icon era-icon" alt="Era" [title]="unit._era?.name" />
                    }
                </div>
                @if (getSortSlot(unit); as slot) {
                <div class="info-slot sort-slot" [class.numeric]="slot.numeric && slot.img">
                    <span class="value">
                        @if(slot.label) { {{ slot.label }}: } {{ slot.value }}
                    </span>
                    @if (slot.img) {<img [src]="slot.img" class="icon" [alt]="slot.alt">}
                </div>
                }
            </div>
            <span class="spanner"></span>
            <unit-tags [unit]="unit" mode="compact" (tagClick)="onAddTag($event)" />
        </div>
    </div>
</ng-template>

<ng-template #expandedCardTpl let-unit="unit">
    <div class="expanded-unit-card">
        <!-- Header Section -->
        <div class="expanded-header">
            <div class="expanded-image">
                <unit-icon [unit]="unit" [size]="56"></unit-icon>
            </div>
            <div class="expanded-title">
                <div class="expanded-model" [innerHTML]="highlight(unit.model)"></div>
                <div class="expanded-chassis" [innerHTML]="highlight(unit.chassis)"></div>
            </div>
            <div class="expanded-subtitle">
                @if (unit.role && unit.role !== 'None') {
                <div class="subtitle-line role">{{ unit.role }}</div>
                }
                <div class="subtitle-line">
                    <span>{{ unit.type }}@if(unit.subtype && unit.subtype !== unit.type){<span> - {{ unit.subtype
                            }}</span>}</span>
                    <span> • {{ unit.weightClass }}</span>
                </div>
                <div class="subtitle-line">
                    <unit-tags [unit]="unit" mode="full" (tagClick)="onAddTag($event)" />
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="expanded-content">
            <!-- Left Column: Basic Info & Stats -->
            <div class="expanded-basic">
                <!-- Basic Info Grid -->
                <div class="expanded-basic-info">
                    <div class="info-item">
                        <span class="info-label muted">BV:</span>
                        <span class="info-value" [class.sort-slot]="this.filtersService.selectedSort() === 'bv'">{{
                            unit | adjustedBV:gunnery:piloting | formatNumber:true:false }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label muted">Tons:</span>
                        <span class="info-value" [class.sort-slot]="this.filtersService.selectedSort() === 'tons'">{{
                            unit.tons | formatTons }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label muted">Rules:</span>
                        <span class="info-value" [class.sort-slot]="this.filtersService.selectedSort() === 'level'">{{
                            unit.level }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label muted">Intro Year: </span>
                        <span class="info-value" [class.sort-slot]="this.filtersService.selectedSort() === 'year'">{{
                            unit.year }} @if(unit._era?.img) {
                            <img [src]="unit._era.img" class="era-icon" [alt]="unit._era?.name"
                                [title]="unit._era?.name" /> }</span>

                    </div>
                    <div class="info-item">
                        <span class="info-label muted">Tech:</span>
                        <span class="info-value"
                            [class.sort-slot]="this.filtersService.selectedSort() === 'techBase'">{{ unit.techBase
                            }}</span>
                    </div>
                    @if (unit.cost) {
                    <div class="info-item">
                        <span class="info-label muted">C-Bill:</span>
                        <span class="info-value">{{ unit.cost | formatNumber:true:false }}</span>
                    </div>
                    }
                    @if (unit.armorType) {
                    <div class="info-item">
                        <span class="info-label muted">Armor:</span>
                        <span class="info-value">{{ unit.armorType }}</span>
                    </div>
                    }
                    @if (unit.structureType) {
                    <div class="info-item">
                        <span class="info-label muted">Structure:</span>
                        <span class="info-value">{{ unit.structureType }}</span>
                    </div>
                    }
                    @if (unit.moveType) {
                    <div class="info-item">
                        <span class="info-label muted">Motive:</span>
                        <span class="info-value">{{ unit.moveType }}</span>
                    </div>
                    }
                    @if (unit.engine) {
                    <div class="info-item">
                        <span class="info-label muted">Engine:</span>
                        <span class="info-value">@if(unit.engineRating){ {{ unit.engineRating }} }{{ unit.engine
                            }}</span>
                    </div>
                    }
                    @if (unit.c3) {
                    <div class="info-item">
                        <span class="info-label muted">Network:</span>
                        <span class="info-value">{{ unit.c3 }}</span>
                    </div>
                    }
                    @if (unit.walk) {
                    <div class="info-item">
                        <span class="info-label muted">Movement:</span>
                        <span class="info-value">{{ unit.walk }} / {{ unit.run }}
                            @if(unit.run2 != unit.run){ [{{ unit.run2 }}]}
                            @if(unit.jump){ / {{ unit.jump }} }
                            @if (unit.umu) { / {{ unit.umu }}}
                        </span>
                    </div>
                    }
                </div>

            </div>

            <div class="expanded-stats">
                <div class="stat-bars-columns">
                    @if((unit | statBarSpecs); as specsList) {
                    @for (spec of specsList; let i = $index; track i) {
                    <div class="stat-bar-row" [tooltip]="spec.description ?? null">
                        <div class="stat-bar">
                            <div class="stat-bar-fill" [style.width.%]="spec.percent"></div>
                        </div>
                        <span class="stat-label">{{ spec.label }}</span>
                        <span class="stat-value">{{ spec.valueText ?? spec.value }}</span>
                    </div>
                    }
                    }
                </div>
            </div>

            <div class="expanded-right">
                <!-- Right Column: Components -->
                @if ((unit.comp | expandedComponents); as componentsList) {
                @if (componentsList.length > 0) {
                <div class="components-header">Equipment</div>
                <div class="expanded-components">
                    <div class="components-pills">
                        @for (comp of componentsList; let last = $last; let i = $index; track i) {
                        <unit-component-item [unit]="unit" [comp]="comp" displayStyle="tiny"></unit-component-item>
                        }
                    </div>
                </div>
                }
                }
                @if ((unit.comp | filterAmmo); as ammoList) {
                @if (ammoList.length > 0) {
                <div class="ammo-list">
                    <span class="info-label muted">Ammo: </span>
                    @for (comp of ammoList; let last = $last; let i = $index; track i) {
                    <unit-component-item [unit]="unit" [comp]="comp"
                        displayStyle="text"></unit-component-item>@if(!last){<span>, </span>}
                    }
                </div>
                }
                }
            </div>
        </div>
    </div>
</ng-template>

<ng-template #expandedViewASCard let-unit="unit">
    <div class="expanded-unit-card as-card-view">
        <!-- Header Section -->
        <div class="expanded-header">
            <div class="expanded-image">
                <unit-icon [unit]="unit" [size]="56"></unit-icon>
            </div>
            <div class="expanded-title">
                <div class="expanded-model" [innerHTML]="highlight(unit.model)"></div>
                <div class="expanded-chassis" [innerHTML]="highlight(unit.chassis)"></div>
            </div>
            <div class="expanded-subtitle">
                @if (unit.role && unit.role !== 'None') {
                <div class="subtitle-line role">{{ unit.role }}</div>
                }
                <div class="subtitle-line">
                    <span>{{ unit.as.TP }}</span>
                    <span> • {{ unit.weightClass }}</span>
                </div>
                <div class="subtitle-line">
                    <unit-tags [unit]="unit" mode="full" (tagClick)="onAddTag($event)" />
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="expanded-content as-view">
            <!-- Left Column: Basic Info & Stats -->
            <div class="expanded-basic">
                <!-- Basic Info Grid -->
                <div class="expanded-basic-info">
                    <div class="info-item">
                        <span class="info-label muted">PV:</span>
                        <span class="info-value" [class.sort-slot]="this.filtersService.selectedSort() === 'as.PV'">{{
                            unit.as.PV | adjustedPV:gunnery | formatNumber:true:false }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label muted">Size:</span>
                        <span class="info-value" [class.sort-slot]="this.filtersService.selectedSort() === 'as.SZ'">{{
                            unit.as.SZ }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label muted">TMM:</span>
                        <span class="info-value" [class.sort-slot]="this.filtersService.selectedSort() === 'as.TMM'">{{
                            unit.as.TMM }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label muted">Movement:</span>
                        <span class="info-value">{{ formatASMovement(unit) }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label muted">Armor:</span>
                        <span class="info-value">{{ unit.as.Arm }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label muted">Structure:</span>
                        <span class="info-value">{{ unit.as.Str }}</span>
                    </div>
                    @if (!unit.as.usesArcs) {
                    <div class="info-item">
                        <span class="info-label muted">Damage:</span>
                        <span class="info-value">{{ unit.as.dmg.dmgS }}/{{ unit.as.dmg.dmgM }}/{{ unit.as.dmg.dmgL
                            }}</span>
                    </div>
                    }
                    @if (unit.as.usesOV) {
                    <div class="info-item">
                        <span class="info-label muted">Overheat:</span>
                        <span class="info-value">{{ unit.as.OV }}</span>
                    </div>
                    }
                    @if (unit.as.usesTh) {
                    <div class="info-item">
                        <span class="info-label muted">Thrust:</span>
                        <span class="info-value">{{ unit.as.Th }}</span>
                    </div>
                    }
                    <div class="info-item">
                        <span class="info-label muted">Intro Year: </span>
                        <span class="info-value" [class.sort-slot]="this.filtersService.selectedSort() === 'year'">{{
                            unit.year }} @if(unit._era?.img) {
                            <img [src]="unit._era.img" class="era-icon" [alt]="unit._era?.name"
                                [title]="unit._era?.name" /> }</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label muted">Tech:</span>
                        <span class="info-value"
                            [class.sort-slot]="this.filtersService.selectedSort() === 'techBase'">{{ unit.techBase
                            }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label muted">Tons:</span>
                        <span class="info-value" [class.sort-slot]="this.filtersService.selectedSort() === 'tons'">{{
                            unit.tons | formatTons }}</span>
                    </div>
                </div>
            </div>

            <!-- Right Column: Specials -->
            <div class="expanded-right">
                @if (unit.as.specials && unit.as.specials.length > 0) {
                <div class="components-header">Special:</div>
                <div class="expanded-specials">
                    <div class="specials-pills">
                        @for (special of unit.as.specials; let last = $last; let i = $index; track i) {
                        <span class="special-pill" (click)="showAbilityInfoDialog(special); $event.stopPropagation()"
                            title="Click for details">{{ special }}</span>
                        }
                    </div>
                </div>
                }
            </div>
        </div>
    </div>
    <!-- Table Row View (shown via CSS at >= 1200px) -->
    <div class="as-table-row">
        <div class="as-td as-td-icon"><unit-icon [unit]="unit" [size]="36"></unit-icon></div>
        <div class="as-td as-td-name">
            <span class="as-td-model" [innerHTML]="highlight(unit.model)"></span>
            <span class="as-td-chassis" [innerHTML]="highlight(unit.chassis)"></span>
        </div>
        <div class="as-td as-td-type">{{ unit.as.TP }}</div>
        <div class="as-td as-td-role">{{ unit.role !== 'None' ? unit.role : '' }}</div>
        <div class="as-td as-td-pv" [class.sort-slot]="this.filtersService.selectedSort() === 'as.PV'">{{ unit.as.PV |
            adjustedPV:gunnery | formatNumber:true:false }}</div>
        <div class="as-td as-td-sz" [class.sort-slot]="this.filtersService.selectedSort() === 'as.SZ'">{{ unit.as.SZ }}
        </div>
        <div class="as-td as-td-mv">{{ formatASMovement(unit) }}</div>
        <div class="as-td as-td-tmm" [class.sort-slot]="this.filtersService.selectedSort() === 'as.TMM'">{{ unit.as.TMM
            }}</div>
        <div class="as-td as-td-dmg">@if (!unit.as.usesArcs) { {{ unit.as.dmg.dmgS }}/{{ unit.as.dmg.dmgM }}/{{
            unit.as.dmg.dmgL }} }</div>
        <div class="as-td as-td-arm">{{ unit.as.Arm }}</div>
        <div class="as-td as-td-str">{{ unit.as.Str }}</div>
        <div class="as-td as-td-ov">@if (unit.as.usesOV) { {{ unit.as.OV }} }</div>
        <div class="as-td as-td-specials">
            @for (special of unit.as.specials; let i = $index; track i) {
            <span class="special-pill" (click)="showAbilityInfoDialog(special); $event.stopPropagation()"
                title="Click for details">{{ special }}</span>
            }
        </div>
        <div class="as-td as-td-tags">
            <unit-tags [unit]="unit" mode="full" size="small" (tagClick)="onAddTag($event)" />
        </div>
    </div>
</ng-template>