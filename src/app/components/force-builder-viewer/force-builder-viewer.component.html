<div class="force-viewer-container">
    <div id="force-view" class="force-view">
        <div class="force-name" (click)="promptChangeForceName()">{{ forceName() }}</div>
        @if (forceBuilderService.readOnlyForce()) {
        <button class="bt-button btn-clone" (click)="forceBuilderService.requestCloneForce()">CLONE FORCE TO
            EDIT</button>
        }
        <div #scrollableContent class="scrollable-content" cdkScrollable>
            <div class="force-units-list" [class.single-group]="hasSingleGroup()">
                @for (group of forceBuilderService.force.groups(); let gi = $index; track gi) {
                <div class="group-container">
                    <div class="group-header">
                        <div class="group-name" (click)="promptChangeGroupName(group)">{{ group.name() }}</div>
                        <div class="group-footer">
                            <span class="group-bv">BV: {{ group.totalBV() | number }}</span>
                        </div>
                    </div>
                    @let units = group.units();
                    <div class="group-units" cdkDropList [class.compact-mode]="compactMode()" id="group-{{ group.id }}"
                        cdkDropListOrientation="vertical" [cdkDropListData]="units"
                        [cdkDropListConnectedTo]="connectedDropLists()"
                        [cdkDropListDisabled]="compactMode() || forceBuilderService.readOnlyForce()"
                        (cdkDropListDropped)="drop($event)">
                        @if (units.length === 0) {
                        <div class="empty-group-placeholder" (click)="onEmptyGroupClick(group)">
                            No units in this group.<br />Drop units here to add them or click to remove it.
                        </div>
                        }
                        @for (unit of units; let i = $index; track i) {
                        <div #forceUnitItem [id]="'unit-'+unit.id" class="force-unit-item" (click)="selectUnit(unit)"
                            tabindex="0" (keydown)="onUnitKeydown($event, i)" cdkDrag
                            [cdkDragDisabled]="forceBuilderService.readOnlyForce()" (cdkDragStarted)="onUnitDragStart()"
                            (cdkDragMoved)="onUnitDragMoved($event)" (cdkDragEnded)="onUnitDragEnd()"
                            [cdkDragLockAxis]="lockAxis()!" cdkDragBoundary=".scrollable-content"
                            [cdkDragStartDelay]="layoutService.isTouchInput() ? 200 : 0">
                            <unit-block class="selectable" [forceUnit]="unit" [compactMode]="compactMode()"
                                [class.selected]="unit.id === forceBuilderService.selectedUnit()?.id"
                                (onRemoveUnit)="removeUnit($event, unit)" (onInfo)="showUnitInfo($event, unit)"
                                (onToggleC3)="toggleC3Link($event, unit)"></unit-block>
                        </div>
                        }
                    </div>
                </div>
                }
                @if (!compactMode() && !forceBuilderService.readOnlyForce() && !isUnitDragging() &&
                !forceBuilderService.force.hasMaxGroups()) {
                <button class="bt-button btn-add-group" (click)="forceBuilderService.addGroup()">+ Add Group</button>
                }
                <div class="group-container new-group-dropzone" cdkDropList id="new-group-dropzone"
                    [cdkDropListConnectedTo]="connectedDropLists()" [cdkDropListData]="[]"
                    [class.visible]="isUnitDragging() && !hasEmptyGroups() && !forceBuilderService.force.hasMaxGroups()"
                    [cdkDropListDisabled]="forceBuilderService.readOnlyForce()"
                    (cdkDropListDropped)="dropForNewGroup($event)">
                    <div class="group-name">New Group</div>
                    <div class="new-group-placeholder">Drop units here to form a new group</div>
                </div>
            </div>
        </div>
        <div class="footer">
            @if (!hasSingleGroup()) {
            <div class="row total-bv">Total BV: {{ forceBuilderService.force.totalBv() | number }}</div>
            }
            <div class="row">
                <button class="bt-button square" (click)="toggleCompactMode()" title="Toggle Compact Mode">
                    @if (compactMode()) {
                    <svg width="20px" height="20px" viewBox="0 0 35 35" fill="currentcolor" version="1.1"
                        xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M34.999,0H0.001v6.777h34.997L34.999,0L34.999,0z M32.999,4.777H2.001V2h30.997L32.999,4.777L32.999,4.777z" />
                        <rect y="8.642" width="35" height="11.072" />
                        <rect y="21.928" width="35" height="13.072" />
                    </svg>
                    } @else {
                    <svg width="20px" height="20px" viewBox="0 0 31 31" fill="currentcolor" version="1.1"
                        xmlns="http://www.w3.org/2000/svg">
                        <rect x="1" y="1" width="7" height="7" />
                        <rect x="12" y="1" width="7" height="7" />
                        <rect x="23" y="1" width="7" height="7" />
                        <rect x="1" y="12" width="7" height="7" />
                        <rect x="12" y="12" width="7" height="7" />
                        <rect x="23" y="12" width="7" height="7" />
                        <rect x="1" y="23" width="7" height="7" />
                        <rect x="12" y="23" width="7" height="7" />
                        <rect x="23" y="23" width="7" height="7" />
                    </svg>
                    }
                </button>
                <button class="bt-button square share-btn" (click)="shareForce()" title="Share Force">
                    <svg width="20px" height="20px" viewBox="0 0 24 24" fill="currentColor"
                        xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd"
                            d="M13.803 5.33333C13.803 3.49238 15.3022 2 17.1515 2C19.0008 2 20.5 3.49238 20.5 5.33333C20.5 7.17428 19.0008 8.66667 17.1515 8.66667C16.2177 8.66667 15.3738 8.28596 14.7671 7.67347L10.1317 10.8295C10.1745 11.0425 10.197 11.2625 10.197 11.4872C10.197 11.9322 10.109 12.3576 9.94959 12.7464L15.0323 16.0858C15.6092 15.6161 16.3473 15.3333 17.1515 15.3333C19.0008 15.3333 20.5 16.8257 20.5 18.6667C20.5 20.5076 19.0008 22 17.1515 22C15.3022 22 13.803 20.5076 13.803 18.6667C13.803 18.1845 13.9062 17.7255 14.0917 17.3111L9.05007 13.9987C8.46196 14.5098 7.6916 14.8205 6.84848 14.8205C4.99917 14.8205 3.5 13.3281 3.5 11.4872C3.5 9.64623 4.99917 8.15385 6.84848 8.15385C7.9119 8.15385 8.85853 8.64725 9.47145 9.41518L13.9639 6.35642C13.8594 6.03359 13.803 5.6896 13.803 5.33333Z" />
                    </svg>
                </button>
                <button class="bt-button square" title="Print All" (click)="printAll()">
                    <svg stroke="currentColor" width="20px" height="20px" viewBox="0 0 24 24" fill="none"
                        xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M7 17H5C3.89543 17 3 16.1046 3 15V11C3 9.34315 4.34315 8 6 8H7M7 17V14H17V17M7 17V18C7 19.1046 7.89543 20 9 20H15C16.1046 20 17 19.1046 17 18V17M17 17H19C20.1046 17 21 16.1046 21 15V11C21 9.34315 19.6569 8 18 8H17M7 8V6C7 4.89543 7.89543 4 9 4H15C16.1046 4 17 4.89543 17 6V8M7 8H17M15 11H17"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </button>
                <button class="bt-button square" [cdkMenuTriggerFor]="addToForcePopupMenu" title="Add to Force">
                    <svg width="20px" height="20px" viewBox="0 0 24 24" fill="currentColor"
                        xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd"
                            d="M11.25 12.75V18H12.75V12.75H18V11.25H12.75V6H11.25V11.25H6V12.75H11.25Z" />
                    </svg>
                </button>
                <ng-template #addToForcePopupMenu>
                    <div class="popup-menu framed-borders" cdkMenu>
                        <button class="menu-item" cdkMenuItem (click)="showForcePackDialog()">Add a Force
                            Pack...</button>
                        <!-- <hr />
                        <button class="menu-item" cdkMenuItem>Friendly Force</button>
                        <button class="menu-item" cdkMenuItem>Opposing Force</button> -->
                    </div>
                </ng-template>
                <!-- <button class="bt-button square opfor-btn" title="OpFor">
                    <svg fill="currentColor" version="1.1" width="24px" height="24px" viewBox="0 0 96 96"
                        xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M 33.9,94.4 31.4,94.3 31.1,93.8 30.8,93.2 30.4,91 c -0.4,-2.2 -1,-6.2 -1.7,-9.9 -0.2,-1 -0.6,-3 -0.8,-4.5 -0.3,-1.6 -0.6,-3.5 -0.8,-4.4 l -0.3,-1.6 h -0.3 c -0.1,-0.1 -0.7,-0.3 -1.2,-0.5 -0.5,-0.3 -1,-0.5 -1.1,-0.5 -0.2,0 -0.6,-0.2 -1,-0.4 -0.4,-0.1 -2.8,-1.1 -5.3,-2.1 -2.5,-1 -4.7,-1.9 -4.8,-2 -0.2,0 -0.6,-0.6 -1,-1.3 -0.4,-0.7 -1.4,-2.4 -2.16,-3.7 L 8.52,57.7 v -0.6 c 0,-0.6 0,-0.9 0.84,-4.2 L 9.81,51 9.1,49.8 8.4,48.5 7.94,46.4 C 7.68,45.2 7.35,43.5 7.19,42.6 L 6.91,40.9 7.02,38.3 C 7.49,27.5 12.5,17.8 21.1,10.8 28.1,5.17 35,2.54 44.3,1.86 L 48,1.6 51.7,1.86 c 9.3,0.68 16.2,3.31 23.2,8.94 8.6,7 13.6,16.7 14.1,27.5 l 0.1,2.6 -0.3,1.7 c -0.1,0.9 -0.5,2.6 -0.7,3.8 l -0.5,2.1 -0.7,1.3 -0.7,1.2 0.5,1.9 c 0.8,3.3 0.8,3.6 0.8,4.2 v 0.6 l -1.4,2.4 c -0.8,1.3 -1.8,3 -2.2,3.7 -0.4,0.7 -0.8,1.3 -1,1.3 -0.1,0.1 -2.3,1 -4.8,2 -2.5,1 -4.9,2 -5.3,2.1 -0.4,0.2 -0.8,0.4 -1,0.4 -0.1,0 -0.6,0.2 -1.1,0.5 -0.5,0.2 -1.1,0.4 -1.2,0.5 h -0.3 l -0.3,1.6 c -0.2,0.9 -0.5,2.8 -0.8,4.4 -0.2,1.5 -0.6,3.5 -0.8,4.5 -0.7,3.7 -1.3,7.7 -1.7,9.9 l -0.4,2.2 -0.3,0.6 -0.3,0.5 -2.6,0.1 c -1.4,0 -3.1,0 -3.6,-0.1 L 57.3,94.1 57.1,93.9 57,93.6 58.4,86.7 c 0.7,-3.8 1.3,-7 1.3,-7.1 l 0.1,-0.2 h -1 -0.9 l -0.2,0.8 c 0,0.4 -0.6,3.7 -1.2,7.3 l -1.1,6.4 -0.3,0.2 -0.3,0.2 h -2.9 -3 L 48.8,94 c 0,-0.1 -0.1,-3.6 -0.1,-7.6 L 48.6,79.1 H 48 47.4 l -0.1,7.3 c 0,4 -0.1,7.5 -0.1,7.6 l -0.1,0.3 h -3 -2.9 l -0.3,-0.2 -0.3,-0.2 -1.1,-6.4 c -0.6,-3.6 -1.2,-6.9 -1.2,-7.3 l -0.2,-0.8 h -0.9 -1 l 0.1,0.2 c 0,0.1 0.6,3.3 1.3,7.1 l 1.4,7 -0.3,0.3 -0.3,0.3 h -0.7 c -0.4,0 -0.8,0.1 -1,0.1 -0.2,0 -1.4,0 -2.8,0 z m 17.4,-27.2 2.9,-1.7 v -0.4 c 0,-1.4 -6.1,-21.4 -6.3,-21.1 -0.2,0.2 -6.1,20.6 -6.1,21.1 v 0.4 l 2.9,1.7 c 3.6,2 3,2 6.6,0 z M 35.3,52.6 C 37,50.9 38.5,49.3 38.6,49 l 0.3,-0.5 -0.8,-1.3 C 37.4,46 37.1,45.5 36,43.5 35.7,43 35.3,42.3 35,41.9 l -0.5,-0.6 h -9.1 -9.1 l -2.4,1.8 -2.4,1.8 v 3 3 l 2.4,2.4 2.3,2.3 8.1,0.1 h 8 z m 46.8,0.7 2.4,-2.4 v -3 -3 L 82.1,43.1 79.7,41.3 H 70.6 61.5 L 61,41.9 c -0.3,0.4 -0.7,1.1 -1,1.6 -1.1,2 -1.4,2.5 -2.1,3.7 l -0.8,1.3 0.3,0.5 c 0.1,0.3 1.6,1.9 3.3,3.6 l 3,3.1 h 8 8 z" />
                    </svg>
                </button> -->
                <div class="spanner"></div>

                <!-- <button class="bt-button square workshop-btn" title="Workshop">
                    <svg fill="currentColor" height="24px" width="24px" version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" xml:space="preserve">
                        <path class="st0" d="M202.622,344.796l-6.208,11.926l-0.263,0.484c-14.411,24.499-41.026,39.714-69.478,39.714
		c-14.272,0-28.371-3.847-40.731-11.122c-18.544-10.908-31.733-28.37-37.122-49.195c-0.238-0.886-0.434-1.78-0.632-2.674
		L37.92,412.74h173.617L202.622,344.796z" />
                        <path class="st0" d="M212.883,59.091L66.446,280.944c-19.578,33.283-8.465,76.172,24.844,95.749
		c33.299,19.587,76.17,8.464,95.756-24.843l99.391-191.063l-54.788-52.082C217.361,93.974,212.497,77.52,212.883,59.091z
		 M150.794,330.533c-7.808,13.288-24.909,17.716-38.188,9.916c-13.287-7.824-17.724-24.909-9.907-38.196
		c7.808-13.288,24.909-17.716,38.187-9.908C154.165,300.161,158.611,317.254,150.794,330.533z" />
                        <path class="st0" d="M216.401,422.247H34.278c-12.402,0-22.449,10.055-22.449,22.457V512h227.012v-67.296
		C238.841,432.302,228.794,422.247,216.401,422.247z" />
                        <path class="st0" d="M450.024,185.737c7.184,0,14.082,1.255,20.48,3.559L328.505,19.542c-22.646-24.606-60.956-26.188-85.554-3.535
		c-24.606,22.637-26.18,60.949-3.535,85.546l149.955,142.458C390.65,211.663,417.356,185.737,450.024,185.737z M299.584,77.537
		c-9.374,8.628-23.973,8.013-32.602-1.361c-8.645-9.375-8.038-23.974,1.345-32.603c9.375-8.644,23.974-8.038,32.619,1.346
		C309.575,54.293,308.967,68.892,299.584,77.537z" />
                        <polygon class="st0"
                            points="431.668,365.227 451.246,387.249 470.815,365.227 470.815,328.975 431.668,328.975" />
                        <path class="st0"
                            d="M450.024,196.292c-27.698,0-50.155,22.449-50.155,50.155v72.169h100.301v-72.169
		C500.171,218.741,477.73,196.292,450.024,196.292z M450.024,264.492c-10.818,0-19.578-8.768-19.578-19.578
		c0-10.818,8.76-19.586,19.578-19.586c10.81,0,19.586,8.767,19.586,19.586C469.61,255.723,460.835,264.492,450.024,264.492z" />
                    </svg>
                </button> -->
                <button class="bt-button square" [cdkMenuTriggerFor]="generalMenu" title="Menu">
                    <svg width="20px" height="20px" viewBox="0 0 24 24" fill="currentColor"
                        xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd"
                            d="M12 7C10.3431 7 9 5.65685 9 4C9 2.34315 10.3431 1 12 1C13.6569 1 15 2.34315 15 4C15 5.65685 13.6569 7 12 7ZM12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9ZM12 17C10.3431 17 9 18.3431 9 20C9 21.6569 10.3431 23 12 23C13.6569 23 15 21.6569 15 20C15 18.3431 13.6569 17 12 17Z" />
                    </svg>
                </button>
                <ng-template #generalMenu>
                    <div class="popup-menu framed-borders" cdkMenu>
                        <button class="menu-item" cdkMenuItem (click)="requestNewForce()">
                            <span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="true">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z" fill="currentColor"/>
                                    <path d="M14 2v6h6" fill="currentColor"/>
                                    <rect x="7" y="12" width="10" height="1.5" rx="0.75" fill="white" opacity="0.15"/>
                                    <rect x="7" y="15" width="6" height="1.5" rx="0.75" fill="white" opacity="0.15"/>
                                </svg></span> New Force</button>
                        <button class="menu-item" [hidden]="forceBuilderService.readOnlyForce()" cdkMenuItem
                            (click)="requestRepairAll()">
                            <span class="icon"><svg fill="currentColor" height="32px" width="32px" version="1.1"
                                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 143.734 143.734"
                                    xml:space="preserve">
                                    <path d="M119.743,103.298l-29.84-29.84l24.22-24.22c7.864,1.826,16.457-0.269,22.597-6.408
		c6.719-6.713,8.562-16.367,5.74-24.81l-11.403,11.397c-4.034,4.046-10.693,3.92-14.893-0.28
		c-4.183-4.189-4.314-10.848-0.286-14.887l11.397-11.397c-8.425-2.84-18.074-0.985-24.804,5.74
		c-6.128,6.122-8.216,14.714-6.385,22.591l-24.22,24.214L47.657,31.189c1.826-7.87-0.28-16.463-6.402-22.597
		c-6.713-6.719-16.361-8.568-24.804-5.746l11.397,11.403c4.04,4.034,3.92,10.699-0.286,14.893
		c-4.189,4.189-10.836,4.314-14.887,0.286L1.277,18.026c-2.828,8.431-0.979,18.092,5.752,24.81
		c6.116,6.134,14.708,8.216,22.591,6.396l24.208,24.202l-29.834,29.834c-5.43-0.376-10.979,1.426-15.114,5.585
		c-7.626,7.614-7.626,19.965,0,27.591c7.602,7.608,19.959,7.608,27.573,0c4.147-4.147,5.943-9.702,5.597-15.132l29.816-29.828
		l29.84,29.84c-0.37,5.43,1.438,10.985,5.585,15.126c7.608,7.62,19.971,7.62,27.585,0c7.614-7.614,7.614-19.965,0-27.585
		C130.728,104.719,125.173,102.917,119.743,103.298z M25.311,132.56l-9.923-2.649l-2.643-9.923l7.25-7.262l9.923,2.655l2.655,9.917
		L25.311,132.56z M128.335,129.929l-9.917,2.643l-7.262-7.262l2.649-9.917l9.923-2.655l7.268,7.262L128.335,129.929z" />
                                </svg></span> Repair Force</button>
                        <button class="menu-item" cdkMenuItem
                            (click)="requestCloneForce()">
                            <span class="icon"><svg width="32px" height="32px" viewBox="0 0 16 16" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path d="M0 0H10V4H4V10H0V0Z" fill="currentColor" />
                                    <path d="M16 6H6V16H16V6Z" fill="currentColor" />
                                </svg>
                            </span> Clone Force</button>
                        <button class="menu-item" cdkMenuItem (click)="showLoadForceDialog()">
                            <span class="icon">
                                <svg fill="currentColor" width="32px" height="32px" viewBox="0 0 1920 1920"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path
                                        d="m572.501 747-254.933 815.893-101.867-31.786 278.507-890.774h1105.813v-320H783.808L612.181 107H.021v1546.667c0 88.213 71.787 160 160 160h1388.054c75.946 0 141.973-54.08 156.906-128.64L1892.608 747H572.501Z"
                                        fill-rule="evenodd" />
                                </svg></span> Load Force...</button>
                        <hr />
                        <button class="menu-item" cdkMenuItem (click)="showOptionsDialog()">
                            <span class="icon"><svg fill="currentColor" width="32px" height="32px"
                                    viewBox="0 0 1920 1920" xmlns="http://www.w3.org/2000/svg">
                                    <path
                                        d="M1703.534 960c0-41.788-3.84-84.48-11.633-127.172l210.184-182.174-199.454-340.856-265.186 88.433c-66.974-55.567-143.323-99.389-223.85-128.415L1158.932 0h-397.78L706.49 269.704c-81.43 29.138-156.423 72.282-223.962 128.414l-265.073-88.32L18 650.654l210.184 182.174C220.39 875.52 216.55 918.212 216.55 960s3.84 84.48 11.633 127.172L18 1269.346l199.454 340.856 265.186-88.433c66.974 55.567 143.322 99.389 223.85 128.415L761.152 1920h397.779l54.663-269.704c81.318-29.138 156.424-72.282 223.963-128.414l265.073 88.433 199.454-340.856-210.184-182.174c7.793-42.805 11.633-85.497 11.633-127.285m-743.492 395.294c-217.976 0-395.294-177.318-395.294-395.294 0-217.976 177.318-395.294 395.294-395.294 217.977 0 395.294 177.318 395.294 395.294 0 217.976-177.317 395.294-395.294 395.294"
                                        fill-rule="evenodd" />
                                </svg></span> Options...</button>
                    </div>
                </ng-template>
            </div>
        </div>
    </div>
</div>