<div id="force-view" class="force-view">
    <div #scrollableContent class="scrollable-content" cdkScrollable>
        <div class="forces-drop-list"
            cdkDropList
            cdkDropListOrientation="vertical"
            [cdkDropListData]="loadedSlots()"
            [cdkDropListDisabled]="forceDragDisabled() || compactMode() || miniMode()"
            [cdkDropListAutoScrollDisabled]="true"
            (cdkDropListDropped)="dropForce($event)">
        @for (slot of loadedSlots(); track slot.force; let first = $first) {
        @let slotForce = slot.force;
        @let isActive = slotForce === forceBuilderService.currentForce();
        @let isReadOnly = slotForce.readOnly();
        @let showAlignment = showAlignmentStyling() && (isReadOnly || slot.alignment === 'enemy');
        <div class="force-slot" [class.friendly]="showAlignment && slot.alignment === 'friendly'"
            [class.enemy]="showAlignment && slot.alignment === 'enemy'" [class.active-force]="isActive" [class.mini-mode]="miniMode()" [class.read-only]="isReadOnly"
            cdkDrag [cdkDragDisabled]="forceDragDisabled()"
            (cdkDragStarted)="onForceDragStart()"
            (cdkDragMoved)="onUnitDragMoved($event)"
            (cdkDragEnded)="onForceDragEnd()"
            cdkDragLockAxis="y"
            [cdkDragStartDelay]="layoutService.isTouchInput() ? 200 : 0">
            @if (!miniMode()) {
                @let forceCollapsed = isForceCollapsed(slotForce);
                <div class="force-slot-header" #forceSlotHeader cdkDragHandle>
                    @if (slotForce.groups().length > 1) {
                    <button class="btn-toggle-collapse" (click)="toggleForceCollapsed($event, slotForce)" [title]="forceCollapsed ? 'Expand force' : 'Collapse force'">
                        <svg width="12px" height="12px" fill="currentColor" viewBox="0 0 10 10" xmlns="http://www.w3.org/2000/svg" [class.collapsed]="forceCollapsed">
                            <path d="M0 2l5 6 5-6z"/>
                        </svg>
                    </button>
                    }
                    <div class="force-name" (click)="promptChangeForceName(slotForce)">{{ slotForce.name }}</div>
                    @if (isReadOnly && !hasOwnedForce()) {
                        <button class="bt-button btn-clone primary" (click)="forceBuilderService.requestCloneForce()">CLONE FORCE TO EDIT</button>
                    }
                    @if (loadedSlots().length > 1) {
                        <div class="force-total">Total {{ slotForce.gameSystem === 'as' ? 'PV' : 'BV' }}: {{ slotForce.totalBv() | number }}</div>
                        <button class="btn-remove-force" (click)="removeForceFromSlot($event, slotForce)" title="Remove force">
                            <svg width="12px" height="12px" fill="currentColor" viewBox="0 0 1200 1200" xmlns="http://www.w3.org/2000/svg">
                                <path d="M0,264.84L335.16,600L0,935.16L264.84,1200L600,864.84L935.16,1200L1200,935.16L864.84,600L1200,264.84L935.16,0L600,335.16L264.84,0L0,264.84z" />
                            </svg>
                        </button>
                    }
                </div>
            }
            <div class="force-units-list" 
                id="force-groups-{{ slotForce.instanceId() || slotForce.name }}"
                [class.single-group]="slotForce.groups().length === 1"
                cdkDropList 
                [cdkDropListData]="slotForce.groups()"
                cdkDropListOrientation="vertical"
                [cdkDropListConnectedTo]="connectedGroupDropLists()"
                [cdkDropListDisabled]="compactMode() || miniMode() || isReadOnly"
                [cdkDropListAutoScrollDisabled]="true"
                (cdkDropListDropped)="dropGroup($event)">
                @let groups = slotForce.groups();
                @for (group of groups; let gi = $index; track group.id) {
                @let groupCollapsed = isGroupCollapsed(group.id);
                <div class="group-container" cdkDrag 
                    [cdkDragDisabled]="isReadOnly || groupsDragDisabled()"
                    (cdkDragStarted)="onGroupDragStart()"
                    (cdkDragMoved)="onUnitDragMoved($event)" 
                    (cdkDragEnded)="onGroupDragEnd()"
                    cdkDragLockAxis="y"
                    [cdkDragStartDelay]="layoutService.isTouchInput() ? 200 : 0">
                    @if (!miniMode()) {
                        <div class="group-header" cdkDragHandle>
                            <button class="btn-toggle-collapse group-toggle" (click)="toggleGroupCollapsed($event, group.id)" [title]="groupCollapsed ? 'Expand group' : 'Collapse group'">
                                <svg width="12px" height="12px" fill="currentColor" viewBox="0 0 10 10" xmlns="http://www.w3.org/2000/svg" [class.collapsed]="groupCollapsed">
                                    <path d="M0 2l5 6 5-6z"/>
                                </svg>
                            </button>
                            <div class="group-name" (click)="promptChangeGroupName(group)">{{ group.name() }}</div>
                            <div class="group-footer">
                                <span class="group-bv">{{ slotForce.gameSystem === 'as' ? 'PV' : 'BV' }}: {{ group.totalBV() | number }}</span>
                            </div>
                        </div>
                    } @else {
                        @if (gi !== 0) {
                            <hr />
                        }
                    }
                    @if (!groupCollapsed) {
                    @let units = group.units();
                    <div class="group-units" 
                        [class.compact-mode]="compactMode()" 
                        [class.mini-mode]="miniMode()" 
                        id="group-{{ group.id }}"
                        cdkDropList 
                        cdkDropListOrientation="vertical" 
                        [cdkDropListData]="units"
                        [cdkDropListConnectedTo]="connectedDropLists()"
                        [cdkDropListDisabled]="compactMode() || isReadOnly"
                        [cdkDropListAutoScrollDisabled]="true"
                        (cdkDropListDropped)="drop($event)">
                        @if (units.length === 0) {
                        <div class="empty-group-placeholder" (click)="onEmptyGroupClick(group)">
                            No units in this group.<br />Drop units here to add them or click to remove it.
                        </div>
                        }
                        @for (unit of units; let i = $index; track unit.id) {
                        <div #forceUnitItem [id]="'unit-'+unit.id" class="force-unit-item" (click)="selectUnit(unit)"
                            tabindex="0" (keydown)="onUnitKeydown($event, i)" cdkDrag
                            [cdkDragDisabled]="isReadOnly" (cdkDragStarted)="onUnitDragStart()"
                            (cdkDragMoved)="onUnitDragMoved($event)" (cdkDragEnded)="onUnitDragEnd()"
                            cdkDragLockAxis="y" cdkDragBoundary=".scrollable-content"
                            [cdkDragStartDelay]="layoutService.isTouchInput() ? 200 : 0">
                            <unit-block class="selectable" [forceUnit]="unit" [compactMode]="compactMode() || miniMode()"
                                [class.miniMode]="miniMode()"
                                [class.friendly]="showAlignment && slot.alignment === 'friendly'"
                                [class.enemy]="showAlignment && slot.alignment === 'enemy'"
                                [class.selected]="unit.id === forceBuilderService.selectedUnit()?.id"
                                (onRemoveUnit)="removeUnit($event, unit)" (onInfo)="showUnitInfo($event, unit)"
                                (onRepairUnit)="repairUnit($event, unit)"
                                (onEditPilot)="editPilot($event, unit)"
                                (onOpenC3Network)="openC3Network($event, unit)"></unit-block>
                        </div>
                        }
                    </div>
                    }
                </div>
                }
                @if (!compactMode() && !miniMode() && isActive && !isGroupDragging()) {
                    @if (!isReadOnly && !isUnitDragging() && !slotForce.hasMaxGroups() && !hasEmptyGroups()) {
                    <button class="bt-button btn-add-group" (click)="forceBuilderService.addGroup()">+ Add Group</button>
                    }
                }
                @if (!compactMode() && !miniMode() && !isReadOnly && !isGroupDragging()) {
                    <div
                    id="new-group-dropzone-{{ slotForce.instanceId() || slotForce.name }}"
                    class="group-container new-group-dropzone" 
                    cdkDropList 
                    [cdkDropListConnectedTo]="connectedDropLists()" 
                    [cdkDropListData]="[]"
                    [class.visible]="isUnitDragging() && !hasEmptyGroups() && !slotForce.hasMaxGroups()"
                    [cdkDropListAutoScrollDisabled]="true"
                    (cdkDropListDropped)="dropForNewGroup($event)">
                    <div class="group-name">New Group</div>
                    <div class="new-group-placeholder">Drop units here to form a new group</div>
                </div>
                }
            </div>
        </div>
        }
        </div>
    </div>
    @if (!miniMode() && loadedSlots().length === 1) {
        @let singleForce = loadedSlots()[0].force;
        @if (singleForce.groups().length > 1) {
            <div class="force-slot-footer">
                <div class="row total-bv">Total {{ singleForce.gameSystem === 'as' ? 'PV' : 'BV' }}: {{ singleForce.totalBv() | number }}</div>
            </div>
        }
    }
</div>