<!-- Unit Image -->
@if (imageUrl() && !imageLoadFailed()) {
<div class="fluff-image-container"
    [class.center-vertical]="verticallyCenterImage()"
    [class.reduced-height]="reducedHeightImage()">
    <img class="fluff-image" [src]="imageUrl()" alt="Unit image" (error)="onImageError()" />
</div>
}
<!-- Right side: Era Icons -->
<div class="era-icons">
    @for (item of eraAvailability(); track item.era.id) {
        @if (item.era.icon) {
            <img class="era-icon" 
                 [src]="item.era.icon" 
                 [alt]="item.era.name"
                 [title]="item.era.name"
                 [class.unavailable]="!item.isAvailable" />
        }
    }
</div>

<!-- Header Section -->
<div class="header-section">
    <div class="unit-name">
        @let alias = forceUnit()?.alias();
        @if (alias) {
            @let longChassis = alias.length > 20;
            <div class="model-text" [class.small]="chassisSmall()">{{ chassis() | uppercase }} {{ model() | uppercase }}</div>
            <div class="chassis-text alphastrike-text" [class.stroked]="cardStyle() != 'monochrome'" [class.long-chassis]="longChassis" [class.small]="chassisSmall()">{{ alias }}</div>
        } @else {
            @let longChassis = chassis().length > 20;
            <div class="model-text" [class.small]="chassisSmall()">{{ model() | uppercase}}</div>
            <div class="chassis-text alphastrike-text" [class.stroked]="cardStyle() != 'monochrome'" [class.long-chassis]="longChassis" [class.small]="chassisSmall()">{{ chassis() | uppercase }}</div>
        }
    </div>

    <!-- PV Box -->
    <div class="pv-box-background"></div>
    <div class="pv-box">
        <div class="pv-text">{{ adjustedPV() }}</div>
        @if (basePV() != adjustedPV()) {
        <div class="base-pv-text">Base PV: {{ basePV() }}</div>
        }
    </div>
</div>

<div class="stats-container" #statsContainer>
    <div class="stats-container-row">
        <div class="stats-container-column stats-left">
            <!-- Stats Box 1 - Type, Size, TMM, Movement -->
            <div class="stats-box frame">
                <div class="frame-background"></div>

                <div class="frame-content">
                    <div class="stats-row">
                        <span class="stat-item"><span class="as-caption">TP:</span>&nbsp;<span class="as-value">{{ asStats().TP }}</span></span>
                        <span class="stat-item"><span class="as-caption">SZ:</span>&nbsp;<span class="as-value">{{ asStats().SZ }}</span></span>
                        @if (!isAerospace()) {
                        <span class="stat-item"><span class="as-caption">TMM:</span>&nbsp;<span class="as-value">{{ tmmDisplay() }}</span></span>
                        }
                        <div class="right-column">
                            <span class="stat-item"><span class="as-caption">{{ isAerospace() ? 'THR' : 'MV' }}:</span>&nbsp;<span class="as-value">{{ movementDisplay() }}</span></span>
                            @if (sprintMove()) {
                            <span class="sprint-text">Sprint: {{ sprintMove() }}</span>
                            }
                        </div>
                    </div>
                    <div class="stats-row">
                        <span class="stat-item"><span class="as-caption">ROLE:</span>&nbsp;<span class="as-value">{{ unit().role }}</span></span>
                        <span class="stat-item" [class.clickable]="interactive()" (click)="interactive() && onEditPilotClick()"><span class="as-caption">SKILL:</span>&nbsp;<span class="as-value">{{ skill() }}</span></span>
                    </div>
                </div>
            </div>

            <!-- Damage Box -->
            <div class="damage-box frame">
                <div class="frame-background"></div>
                <div class="frame-content">
                    <div class="damage-label as-value">DAMAGE</div>
                    <div class="damage-ranges">
                        <!-- Short Range -->
                        <div class="damage-range">
                            <div class="range-header range-header-background left" [class.thin]="hasExtremeRange()">S (0 | {{ toHitShort() }}+)</div>
                            <div class="range-value as-value" [class.reduced]="weaponHits() > 0">{{ effectiveDamageS() }}</div>
                            <div class="range-distance">{{ rangeShort() }}</div>
                        </div>

                        <!-- Medium Range -->
                        <div class="damage-range">
                            <div class="range-header range-header-background">M (+2 | {{ toHitMedium() }}+)</div>
                            <div class="range-value as-value" [class.reduced]="weaponHits() > 0">{{ effectiveDamageM() }}</div>
                            <div class="range-distance">{{ rangeMedium() }}</div>
                        </div>

                        <!-- Long Range -->
                        <div class="damage-range">
                            <div class="range-header range-header-background" [class.right]="!hasExtremeRange()">L (+4 | {{ toHitLong() }}+)</div>
                            <div class="range-value as-value" [class.reduced]="weaponHits() > 0">{{ effectiveDamageL() }}</div>
                            <div class="range-distance">{{ rangeLong() }}</div>
                        </div>

                        @if (hasExtremeRange()) {
                            <!-- Extreme Range -->
                            <div class="damage-range">
                                <div class="range-header range-header-background right thin">E (+6 | {{ toHitExtreme() }}+)</div>
                                <div class="range-value as-value" [class.reduced]="weaponHits() > 0">{{ effectiveDamageE() }}</div>
                                <div class="range-distance">{{ rangeExtreme() }}</div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Heat/OV Box -->
            @if (asStats().usesOV) {
            <div class="heat-box frame">
                <div class="frame-background"></div>

                <div class="frame-content">
                    <div class="ov-value">
                        <div class="as-caption">OV:&nbsp;</div>
                        <div class="as-value">{{ asStats().OV }}</div>
                    </div>
                    <div class="frame-title-background heat-label">HEAT SCALE</div>
                    <div class="heat-track">
                        <!-- Heat 0 -->
                        @let pendingHeatDelta = pendingHeat();
                        @let effectiveHeat = heatLevel() + pendingHeatDelta;
                        @let hotDog = forceUnit()?.hasHotDog();
                        <div class="heat-level heat-0" 
                             [class.hot-dog]="hotDog"
                             [class.active]="heatLevel() === 0"
                             [class.pending]="pendingHeatDelta !== 0 && effectiveHeat === 0">
                            <span>0</span>
                        </div>
                        <!-- Heat 1 -->
                        <div class="heat-level heat-1" 
                             [class.hot-dog]="hotDog"
                             [class.active]="heatLevel() === 1"
                             [class.pending]="pendingHeatDelta !== 0 && effectiveHeat === 1">
                            <span>1</span>
                        </div>
                        <!-- Heat 2 -->
                        <div class="heat-level heat-2" 
                             [class.hot-dog]="hotDog"
                             [class.active]="heatLevel() === 2"
                             [class.pending]="pendingHeatDelta !== 0 && effectiveHeat === 2">
                            <span>2</span>
                        </div>
                        <!-- Heat 3 -->
                        <div class="heat-level heat-3" 
                             [class.hot-dog]="hotDog"
                             [class.active]="heatLevel() === 3"
                             [class.pending]="pendingHeatDelta !== 0 && effectiveHeat === 3">
                            <span>3</span>
                        </div>
                        <!-- Heat 4 (Hot Dog ability) -->
                        @if (hotDog) {
                        <div class="heat-level heat-4" 
                             [class.hot-dog]="hotDog"
                             [class.active]="heatLevel() === 4"
                             [class.pending]="pendingHeatDelta !== 0 && effectiveHeat === 4">
                            <span>4</span>
                        </div>
                        }
                        <!-- Shutdown -->
                        <div class="heat-level heat-s" 
                             [class.hot-dog]="hotDog"
                             [class.active]="hotDog ? heatLevel() >= 5 : heatLevel() >= 4"
                             [class.pending]="pendingHeatDelta !== 0 && (hotDog ? effectiveHeat >= 5 : effectiveHeat >= 4)">
                            <span>S</span>
                        </div>
                    </div>
                </div>
            </div>
            }

            <!-- Armor/Structure Box -->
            <div class="armor-box frame">
                <div class="frame-background"></div>
                <div class="frame-content">
                    <div class="pips-wrapper">
                        <!-- Armor Pips -->
                        <div class="pip-row" data-damage-type="armor">
                            <span class="as-caption armor-caption">A:</span>
                            <div class="pips">
                                @for (pipState of armorPipStates(); track pipState.index) {
                                <svg class="pip" 
                                     [class.damaged]="pipState.isDamaged"
                                     [class.pending-damage]="pipState.isPendingDamage"
                                     [class.pending-heal]="pipState.isPendingHeal"
                                     viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" /></svg>
                                }
                            </div>
                        </div>

                        <!-- Structure Pips -->
                        <div class="pip-row" data-damage-type="structure">
                            <span class="as-caption armor-caption">S:</span>
                            <div class="pips">
                                @for (pipState of structurePipStates(); track pipState.index) {
                                <svg class="pip structure" 
                                     [class.damaged]="pipState.isDamaged"
                                     [class.pending-damage]="pipState.isPendingDamage"
                                     [class.pending-heal]="pipState.isPendingHeal"
                                     viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" /></svg>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Thrust (for aerospace units) -->
                    @if (asStats().usesTh) {
                    <div class="thrust-display">
                        <span class="as-caption">TH:</span>
                        <span class="as-value">{{ asStats().Th }}</span>
                    </div>
                    }
                </div>
            </div>
        </div>
        <div class="stats-container-column stats-right">
            
            @let abilities = pilotAbilities();
            @if (abilities.length > 0) {
                <div class="stats-container-row">
                    <div class="pilot-abilities">
                        @for (ability of abilities; track formatPilotAbility(ability)) {
                            <div class="pilot-ability" (click)="onPilotAbilityClick(ability)">{{ formatPilotAbility(ability) }}</div>
                        }
                    </div>
                </div>
            }
            <!-- Critical Hits Box - Rendered based on unit type -->
            @switch (criticalHitsVariant()) {
                @case ('mek') {
                    <as-critical-hits-mek [forceUnit]="forceUnit()" [cardStyle]="cardStyle()" [useHex]="useHex()" [interactive]="interactive()" (rollCritical)="onRollCriticalClick()" />
                }
                @case ('vehicle') {
                    <as-critical-hits-vehicle [forceUnit]="forceUnit()" [cardStyle]="cardStyle()" [useHex]="useHex()" [interactive]="interactive()" (rollCritical)="onRollCriticalClick()" />
                }
                @case ('protomek') {
                    <as-critical-hits-protomek [forceUnit]="forceUnit()" [cardStyle]="cardStyle()" [useHex]="useHex()" [interactive]="interactive()" (rollCritical)="onRollCriticalClick()" />
                }
                @case ('aerofighter') {
                    <as-critical-hits-aerofighter [forceUnit]="forceUnit()" [cardStyle]="cardStyle()" [useHex]="useHex()" [interactive]="interactive()" (rollCritical)="onRollCriticalClick()" />
                }
                @case ('emplacement') {
                    <as-critical-hits-emplacement [forceUnit]="forceUnit()" [cardStyle]="cardStyle()" [useHex]="useHex()" [interactive]="interactive()" (rollCritical)="onRollCriticalClick()" />
                }
            }
        </div>
    </div>


    <!-- Specials Box -->
    @if (effectiveSpecials().length > 0) {
    <div class="stats-container-row">
        <div class="specials-box frame">
            <div class="frame-background"></div>
            <div class="frame-content">
                <span class="as-caption">SPECIAL:&nbsp;</span>
                @for (item of effectiveSpecials(); track item.original; let isLast = $last) {
                <span class="special-ability as-value" 
                      [attr.data-original]="item.original" 
                      [class.exhausted]="item.isExhausted || (item.maxCount && (item.consumedCount ?? 0) >= item.maxCount)"
                      [class.has-consumed]="item.consumedCount"
                      (click)="onSpecialClick(item, $event)">{{ item.effective }}@if (item.maxCount && item.consumedCount) {<span class="consumed-indicator">[{{ item.maxCount - item.consumedCount }}]</span>}@if (!isLast) {<span class="special-separator">,</span>}</span>&nbsp;
                }
            </div>
        </div>
    </div>
    }
</div>

<!-- Destroyed Overlay -->
@if (isDestroyed()) {
<div class="destroyed-overlay">
    <span class="destroyed-text">DESTROYED</span>
</div>
}
