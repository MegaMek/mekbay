<base-dialog [tabs]="tabs()" [activeTab]="activeTab()" (activeTabChange)="activeTab.set($event)">
    <div dialog-header>
        <div class="title">Options</div>
    </div>
    <div dialog-body class="dialog-body">
        @if (activeTab() === 'General') {
        <div class="tab-content">
            <div class="option-row">
                <label for="gameSystem">Default Game system:</label>
                <select id="gameSystem" class="bt-select" [value]="optionsService.options().gameSystem"
                    (change)="onGameSystemChange($event)">
                    <option value="cbt">BattleTech Classic (default)</option>
                    <option value="as">Alpha Strike</option>
                </select>
            </div>
            <div class="option-row">
                <label for="unitDisplayName">Unit display name:</label>
                <select id="unitDisplayName" class="bt-select" [value]="optionsService.options().unitDisplayName"
                    (change)="onUnitDisplayNameChange($event)">
                    <option value="chassisModel">Chassis & model (default)</option>
                    <option value="alias">Pilot name</option>
                    <option value="both">Chassis, model and pilot</option>
                </select>
            </div>
            <div class="option-col">
                <div class="option-row">
                    <label for="autoConvertFilters">Auto-convert filters to semantic:</label>
                    <select id="autoConvertFilters" class="bt-select" [value]="optionsService.options().automaticallyConvertFiltersToSemantic"
                        (change)="onAutoConvertFiltersChange($event)">
                        <option value="true">Enabled</option>
                        <option value="false">Disabled (default)</option>
                    </select>
                </div>
                <div class="description">
                    <p>When enabled, changes to UI filters (dropdowns, sliders) are automatically converted to semantic filter syntax in the search bar.</p>
                    <p>When disabled, UI filters and semantic filters in the search bar work independently and are merged together.</p>
                </div>
            </div>
            <div class="option-col">
                <div class="option-row">
                    <label for="unitSearchExpandedViewLayout">Expanded search layout:</label>
                    <select id="unitSearchExpandedViewLayout" class="bt-select" [value]="optionsService.options().unitSearchExpandedViewLayout"
                        (change)="onunitSearchExpandedViewLayoutChange($event)">
                        <option value="panel-list-filters">Details | Results | Filters (default)</option>
                        <option value="filters-list-panel">Filters | Results | Details</option>
                    </select>
                </div>
                <div class="description">
                    <p>Choose the panel arrangement in expanded unit search view on wide screens.</p>
                </div>
            </div>
            <hr />
            <div class="option-col">
                <label for="userUuid">User identifier:</label>
                <div class="option-row">
                    <input #uuidInput id="userUuid" class="bt-input" [class.error]="!!userUuidError" type="text"
                        [value]="userUuid()" (focus)="selectAll($event)" (keydown)="onUserUuidKeydown($event)" />
                    <button class="bt-button" (click)="onSetUuid(uuidInput.value)">APPLY</button>
                </div>
                @if (userUuidError) {<div class="error-msg">{{ userUuidError }}</div>}
                <div class="description">
                    <p>The User Identifier is used for cloud saving and is autogenerated the first time the application
                        is started.</p>
                    <p>By setting the same ID on multiple devices, you can share your saved forces across them.</p>
                </div>
            </div>
            <div class="option-col">
                <label>Public ID:</label>
                <div class="option-row">
                    <span class="readonly-value">{{ userPublicId() }}</span>
                </div>
                <div class="description">
                    <p>Your Public ID is assigned by the server and can be shared with others to let them subscribe to your public tags.</p>
                </div>
            </div>
        </div>
        }
        @if (activeTab() === 'Tags') {
        <div class="tab-content">
            <div class="option-col tags-description">
                <div class="description">
                    <p>Share your tags with others by copying the link and sending it to them.</p>
                </div>
            </div>
            @if (userOwnTags().length > 0) {
            <div class="tags-list">
                @for (tag of userOwnTags(); track $index) {
                <div class="tag-row">
                    <span class="tag-name">{{ tag }}</span>
                    @if (getSubscriberCount(tag) > 0) {
                    <span class="subscriber-count" title="Number of subscribers">
                        {{ getSubscriberCount(tag) }}
                        <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                    </span>
                    }
                    <div class="tag-actions">
                        <button class="bt-button icon" (click)="onCopyTagLink(tag)" title="Copy shareable link">
                            <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M13.803 5.33333C13.803 3.49238 15.3022 2 17.1515 2C19.0008 2 20.5 3.49238 20.5 5.33333C20.5 7.17428 19.0008 8.66667 17.1515 8.66667C16.2177 8.66667 15.3738 8.28596 14.7671 7.67347L10.1317 10.8295C10.1745 11.0425 10.197 11.2625 10.197 11.4872C10.197 11.9322 10.109 12.3576 9.94959 12.7464L15.0323 16.0858C15.6092 15.6161 16.3473 15.3333 17.1515 15.3333C19.0008 15.3333 20.5 16.8257 20.5 18.6667C20.5 20.5076 19.0008 22 17.1515 22C15.3022 22 13.803 20.5076 13.803 18.6667C13.803 18.1845 13.9062 17.7255 14.0917 17.3111L9.05007 13.9987C8.46196 14.5098 7.6916 14.8205 6.84848 14.8205C4.99917 14.8205 3.5 13.3281 3.5 11.4872C3.5 9.64623 4.99917 8.15385 6.84848 8.15385C7.9119 8.15385 8.85853 8.64725 9.47145 9.41518L13.9639 6.35642C13.8594 6.03359 13.803 5.6896 13.803 5.33333Z"/></svg>
                        </button>
                        <button class="bt-button icon" (click)="onRenameTag(tag)" title="Rename this tag">
                            <svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                        </button>
                        <button class="bt-button icon danger" (click)="onDeleteTag(tag)" title="Delete this tag">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg"><path d="M6 7V18C6 19.1046 6.89543 20 8 20H16C17.1046 20 18 19.1046 18 18V7M6 7H5M6 7H8M18 7H19M18 7H16M10 11V16M14 11V16M8 7V5C8 3.89543 8.89543 3 10 3H14C15.1046 3 16 3.89543 16 5V7M8 7H16"/></svg>
                        </button>
                    </div>
                </div>
                }
            </div>
            } @else {
            <div class="empty-state">
                <p>You don't have any tags yet. Create tags by searching units and clicking on the tag button 
                    <svg class="inline-icon" fill="none" stroke="currentColor" width="20px" height="20px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                        <path d="M21.842 6.218a1.977 1.977 0 0 0-.424-.628A1.99 1.99 0 0 0 20 5H8c-.297 0-.578.132-.769.359l-5 6c-.309.371-.309.91 0 1.281l5 6c.191.228.472.36.769.36h12a1.977 1.977 0 0 0 1.41-.582A1.99 1.99 0 0 0 22 17V7c0-.266-.052-.525-.158-.782z" stroke-width="1.5" />
                        <path d="M14 8V16M10 12H18" stroke-width="2" stroke-linecap="round" />
                    </svg>
                </p>
            </div>
            }

            <div class="option-section-title">Subscribed Tags</div>
            <div class="description" style="padding: 0 0.5em;">
                <p>Tags you've subscribed to from other users.</p>
            </div>
            @if (!showSubscriptionInput()) {
            <div class="option-row">
                <button class="bt-button" (click)="onShowSubscriptionInput()">ADD SUBSCRIPTION</button>
            </div>
            } @else {
            <div class="option-col subscription-input-container">
                <div class="option-row">
                    <input #subscriptionInput class="bt-input" [class.error]="!!subscriptionError()" 
                        type="text" placeholder="publicId:tagName" 
                        (keydown)="onSubscriptionKeydown($event)" />
                    <button class="bt-button primary" (click)="onAddSubscription(subscriptionInput.value)">ADD</button>
                    <button class="bt-button" (click)="onCancelSubscription()">CANCEL</button>
                </div>
                @if (subscriptionError()) {
                <div class="error-msg">{{ subscriptionError() }}</div>
                }
            </div>
            }
            @if (subscribedTags().length > 0) {
            <div class="subscribed-tags-list">
                @for (tag of subscribedTags(); track tag.publicId + ':' + tag.tagName) {
                <div class="subscribed-tag-row">
                    <span class="tag-info">
                        <span class="tag-name">{{ tag.tagName }}</span>
                        <span class="tag-owner">from {{ tag.publicId }}</span>
                    </span>
                    <button class="bt-button danger small" (click)="onUnsubscribePublicTag(tag.publicId, tag.tagName)">Unsubscribe</button>
                </div>
                }
            </div>
            } @else {
            <div class="empty-state">
                <p>You haven't subscribed to any public tags yet.</p>
            </div>
            }
        </div>
        }
        @if (activeTab() === 'Sheets') {
        <div class="tab-content">
            <div class="option-row">
                <label for="sheetsColor">Color schema:</label>
                <select id="sheetsColor" class="bt-select" [value]="optionsService.options().sheetsColor"
                    (change)="onSheetsColorChange($event)">
                    <option value="normal">Normal (default)</option>
                    <option value="night">Night mode</option>
                </select>
            </div>
            <div class="option-col">
                <div class="option-row">
                    <label for="quickActions">Quick actions:</label>
                    <select id="quickActions" class="bt-select" [value]="optionsService.options().quickActions"
                        (change)="onQuickActionsChange($event)">
                        <option value="enabled">Enabled</option>
                        <option value="disabled">Disabled (default)</option>
                    </select>
                </div>
                <div class="description">
                    <p>Quick actions let you trigger the picker's default action with a single tap or click, without
                        opening
                        the picker.</p>
                    <p>Examples: in the Critical Table, clicking an ammo slot reduces ammo by 1; clicking other critical
                        slots applies a critical hit.</p>
                </div>
            </div>
            <div class="option-col">
                <div class="option-row">
                    <label for="useAutomations">Use automations:</label>
                    <select id="useAutomations" class="bt-select" [value]="optionsService.options().useAutomations"
                        (change)="onUseAutomationsChange($event)">
                        <option value="true">Enabled (default)</option>
                        <option value="false">Disabled</option>
                    </select>
                </div>
                <div class="description">
                    <p>Automations provide automatic calculations and effects for various game mechanics, such as
                        turn/phase tracking, PSRs, critical table, and damage application.</p>
                    <p>Disabling automations will require manual tracking of these mechanics during gameplay.</p>
                </div>
            </div>
            <div class="option-row">
                <label for="recordSheetCenterPanelContent">Center panel:</label>
                <select id="recordSheetCenterPanelContent" class="bt-select"
                    [value]="optionsService.options().recordSheetCenterPanelContent"
                    (change)="onRecordSheetCenterPanelContentChange($event)">
                    <option value="clusterTable">Hit location and cluster table (default)</option>
                    <option value="fluffImage">Artwork</option>
                </select>
            </div>
            <div class="option-row">
                <label for="syncZoomBetweenSheets">Sync zoom/pan:</label>
                <select id="syncZoomBetweenSheets" class="bt-select"
                    [value]="optionsService.options().syncZoomBetweenSheets"
                    (change)="onSyncZoomBetweenSheetsChange($event)">
                    <option value="true">Enabled (default)</option>
                    <option value="false">Disabled</option>
                </select>
            </div>
            <div class="option-col">
                <div class="option-row">
                    <label for="allowMultipleActiveSheets">Multiple active sheets:</label>
                    <select id="allowMultipleActiveSheets" class="bt-select"
                        [value]="optionsService.options().allowMultipleActiveSheets"
                        (change)="onAllowMultipleActiveSheetsChange($event)">
                        <option value="true">Enabled</option>
                        <option value="false">Disabled (default)</option>
                    </select>
                </div>
                <div class="description">
                    <p>When enabled, multiple sheets can be displayed side-by-side on wide screens.</p>
                    <p>When disabled, only one active sheet is shown at a time, with neighbor sheets displayed as faded previews.</p>
                </div>
            </div>
            <div class="option-row">
                <label for="swipeToNextSheet">Swipe to next sheet:</label>
                <select id="swipeToNextSheet" class="bt-select" [value]="optionsService.options().swipeToNextSheet"
                    (change)="onSwipeToNextSheetChange($event)">
                    <!-- <option value="vertical">Vertical</option> -->
                    <option value="horizontal">Horizontal</option>
                    <option value="disabled">Disabled</option>
                </select>
            </div>
        </div>
        }
        <!-- Alpha Strike options -->
        @if (activeTab() === 'Alpha Strike') {
        <div class="tab-content">
            <div class="option-row">
                <label for="ASCardStyle">Card theme:</label>
                <select id="ASCardStyle" class="bt-select" [value]="optionsService.options().ASCardStyle"
                    (change)="onASCardStyleChange($event)">
                    <option value="monochrome">Light (default)</option>
                    <option value="colored">Dark</option>
                </select>
            </div>
            <div class="option-row">
                <label for="ASUseHex">Measures:</label>
                <select id="ASUseHex" class="bt-select" [value]="optionsService.options().ASUseHex"
                    (change)="onASUseHexChange($event)">
                    <option value="false">Inches (default)</option>
                    <option value="true">Hexes</option>
                </select>
            </div>
            <div class="option-col">
                <div class="option-row">
                    <label for="ASUnifiedDamagePicker">Unified damage picker:</label>
                    <select id="ASUnifiedDamagePicker" class="bt-select" [value]="optionsService.options().ASUnifiedDamagePicker"
                        (change)="onASUnifiedDamagePickerChange($event)">
                        <option value="true">Enabled (default)</option>
                        <option value="false">Disabled</option>
                    </select>
                </div>
                <div class="description">
                    <p>When enabled: damage is automatically assigned in the order armor->structure.</p>
                    <p>When disabled: damage must be assigned manually to either armor or structure.</p>
                </div>
            </div>
            <div class="option-section-title">Printing</div>
            <div class="option-row">
                <label for="ASPrintPageBreakOnGroups">Split groups in pages:</label>
                <select id="ASPrintPageBreakOnGroups" class="bt-select" [value]="optionsService.options().ASPrintPageBreakOnGroups"
                    (change)="onASPrintPageBreakOnGroupsChange($event)">
                    <option value="true">Yes (default)</option>
                    <option value="false">No</option>
                </select>
            </div>
            <div class="option-section-title">Rules</div>
            <div class="option-col">
                <div class="option-row">
                    <label for="ASUseAutomations">Use automations:</label>
                    <select id="ASUseAutomations" class="bt-select" [value]="optionsService.options().ASUseAutomations"
                        (change)="onASUseAutomationsChange($event)">
                        <option value="true">Enabled (default)</option>
                        <option value="false">Disabled</option>
                    </select>
                </div>
                <div class="description">
                    <p>Automations provide automatic triggers like critical hits rolls or vehicle motive damage.</p>
                    <p>Disabling automations will require manual tracking of these mechanics during gameplay.</p>
                </div>
            </div>
            <div class="option-row">
                <label for="ASVehiclesCriticalHitTable">Vehicles critical hit table:</label>
                <select id="ASVehiclesCriticalHitTable" class="bt-select" [value]="optionsService.options().ASVehiclesCriticalHitTable"
                    (change)="onVehiclesCriticalHitTableChange($event)">
                    <option value="default">Alpha Strike: Commander's Edition (default)</option>
                    <option value="scouringSands">Aces: Scouring Sands</option>
                </select>
            </div>
        </div>
        }
        <!-- Advanced options -->
        @if (activeTab() === 'Advanced') {
        <div class="tab-content">
            <div class="option-row">
                <label for="pickerStyle">Picker style:</label>
                <select id="pickerStyle" class="bt-select" [value]="optionsService.options().pickerStyle"
                    (change)="onPickerStyleChange($event)">
                    <option value="default">Automatic (default)</option>
                    <option value="radial">Always Dial</option>
                    <option value="linear">Always Linear</option>
                </select>
            </div>
            <div class="option-col">
                <div class="option-row">
                    <label for="canvasInput">Drawing input:</label>
                    <select id="canvasInput" class="bt-select" [value]="optionsService.options().canvasInput"
                        (change)="onCanvasInputChange($event)">
                        <option value="all">All</option>
                        <option value="pen">Pen only</option>
                        <option value="touch">Touch only</option>
                    </select>
                </div>
                @if (isIOS) {
                <div class="description">
                    <p>To enhance the performance with Apple Pencil, disable Scribble mode in Settings > Apple Pencil >
                        Scribble.</p>
                </div>
                }
            </div>
            <hr />
            <div class="option-col">
                <div class="option-row">
                    <span>Units loaded: <strong>{{ unitsCount() }}</strong></span>
                </div>
                <div class="option-row">
                    <span>Equipment entries: <strong>{{ equipmentCount() }}</strong></span>
                </div>
            </div>
            <div class="option-row">
                <span>Unit icons stored: <strong>{{ unitIconsCount() }}</strong></span>
                <button class="bt-button" (click)="onPurgeIcons()">PURGE</button>
            </div>
            <div class="option-row">
                <span>Drawings stored: <strong>{{ formatBytes(canvasMemorySize()) }}</strong></span>
                <button class="bt-button" (click)="onPurgeCanvas()">PURGE</button>
            </div>
            <div class="option-col">
                <div class="option-row">
                    <span>Record sheets stored ({{ sheetCacheCount() }}): <strong>{{ formatBytes(sheetCacheSize())
                            }}</strong></span>
                    <button class="bt-button" (click)="onPurgeCache()">PURGE</button>
                </div>
                <div class="description">
                    <p>MekBay caches record sheets locally to speed up loading times and for offline use.</p>
                    <p>Purging the cache will remove all stored sheets. They will be re-downloaded as needed.</p>
                </div>
            </div>
        </div>
        }
        @if (activeTab() === 'Logs') {
        <div class="tab-content debug">
            <div class="logs-list allow-select">
                @for (log of logger.logs().slice().reverse(); let i = $index; track i) {
                <div class="log-row log-{{ log.type.toLowerCase() }}">
                    <span class="log-timestamp">{{ log.timestamp | date:'short' }}</span>
                    <span class="log-message">{{ log.message }}</span>
                </div>
                }
            </div>
            <div class="spanner"></div>
            <div class="option-row debug-controls">
                <button class="bt-button" (click)="logger.clear()">CLEAR</button>
            </div>
        </div>
        }
    </div>
    <div dialog-footer>
        <button class="modal-btn bt-button" (click)="onClose()">DISMISS</button>
    </div>
</base-dialog>