@let unitDisplayName = optionsService.options().unitDisplayName;
<base-dialog modalClass="wide" [tabs]="tabs" [activeTab]="activeTab()" (activeTabChange)="activeTab.set($event)" >
    <div dialog-header>
        <div class="title">Load Force</div>
    </div>
    <div dialog-body>
        @if (!loading()) {
            <div class="search-container">
                <input
                    #searchInput
                    class="bt-input search-input"
                    type="text"
                    placeholder="Search forces, models, chassis, pilots..."
                    [value]="searchText()"
                    (input)="onSearch($any($event.target).value)" />
            </div>
        }
        @if (activeTab() === 'Hangar') {
            <div class="filter-bar">
                <button class="filter-btn" 
                    [class.active]="gameTypeFilter() === 'all'" 
                    (click)="onGameTypeFilter('all')">All</button>
                <button class="filter-btn" 
                    [class.active]="gameTypeFilter() === 'cbt'" 
                    (click)="onGameTypeFilter('cbt')">Battletech</button>
                <button class="filter-btn" 
                    [class.active]="gameTypeFilter() === 'as'" 
                    (click)="onGameTypeFilter('as')">Alpha Strike</button>
            </div>
            @if (loading()) {
                <div class="loading-spinner">Loading forces...</div>
            } @else if (filteredForces().length === 0) {
                <div class="empty-state">No saved forces found.</div>
            } @else {
                <div class="force-list">
                    @for (force of filteredForces(); let i = $index; track force.instanceId) {
                    <div class="force-entry" [class.selected]="selectedForce() === force" (click)="selectForce(force)"
                        tabindex="0">
                        <div class="force-header">
                            <span class="force-name">{{ force.name }}</span>
                            <div class="force-info">                                
                                <span class="force-timestamp">
                                    <span class="game-type-badge" [class.as]="force.type === 'as'">{{ getGameTypeLabel(force.type) }}</span>
                                        @if (force.local) {
                                            <img
                                        src="/images/floppy.svg"
                                        class="save-state-icon" alt="Saved locally"
                                        title="Stored locally" />
                                    }
                                        <img
                                        [src]="force.cloud ? '/images/cloud-check.svg' : '/images/cloud-slash.svg'"
                                        class="save-state-icon" alt="Cloud status"
                                        title="{{ force.cloud ? 'Stored online' : 'Not stored online' }}" />
                                        
                                        {{ force.timestamp | formatTimestamp }}</span>
                                @if (force.type === 'as') {
                                    @if (force.pv && force.pv > 0) {
                                        <span class="force-bv">PV: {{ force.pv | number }}</span>
                                    }
                                } @else {
                                    @if (force.bv && force.bv > 0) {
                                        <span class="force-bv">BV: {{ force.bv | number }}</span>
                                    }
                                }
                            </div>
                        </div>
                        <div class="unit-scroll">
                            @for (group of force.groups; let gi = $index; track gi) {
                            <div class="unit-group">
                                <div class="group-name">{{ group.name }}</div>
                                <div class="units">
                                    @for (unitEntry of group.units; let i = $index; track i) {
                                    <div class="unit-square compact-mode" [class.destroyed]="unitEntry.destroyed" [class.missing]="!unitEntry.unit">
                                        <unit-icon [unit]="unitEntry.unit"></unit-icon>
                                        @if (unitDisplayName === 'chassisModel' 
                                            || unitDisplayName === 'both'
                                            || !unitEntry.alias) {
                                        <div class="unit-model">{{ unitEntry.unit?.model | cleanModelString }}</div>
                                        <div class="unit-chassis">{{ unitEntry.unit?.chassis }}</div>
                                        }
                                        @if (unitDisplayName === 'alias' || unitDisplayName === 'both') {
                                        <div class="unit-alias" 
                                            [class.thin]="unitDisplayName === 'both'">{{ unitEntry.alias }}</div>
                                        }
                                    </div>
                                    }
                                </div>
                            </div>
                            }
                        </div>
                    </div>
                    }
                </div>
            }   
        }
        @if (activeTab() === 'Force Packs') {
            @if (filteredPacks().length === 0) {
                <div class="empty-state">No force pack found.</div>
            } @else {
            <div class="force-list"> 
                    @for (pack of filteredPacks(); let i = $index; track i) {
                    <div class="force-entry" [class.selected]="selectedPack() === pack" (click)="selectPack(pack)" tabindex="0">
                        <div class="force-header">
                            <span class="force-name">
                                {{ pack.name }}
                                @if (pack.variantName) {
                                    <span class="variant-name"> ({{ pack.variantName }} variant)</span>
                                }
                            </span>
                                <div class="force-info">
                                    @if (gameService.isAlphaStrike()) {
                                        <span class="force-bv">PV: {{ pack.pv | number }}</span>
                                    } @else {
                                        <span class="force-bv">BV: {{ pack.bv | number }}</span>
                                    }
                                </div>
                        </div>
                        <div class="unit-scroll">
                            <div class="unit-group">
                                <div class="units">
                                    @for (pu of pack.units; let j = $index; track j) {
                                    <div class="unit-square compact-mode" [class.missing]="!pu.unit">                                        
                                        <unit-icon [unit]="pu.unit"></unit-icon>
                                        <div class="unit-model">{{ pu.unit?.model || pu.model || '' }}</div>
                                        <div class="unit-chassis">{{ pu.unit?.chassis || pu.chassis }}</div>
                                    </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                    }
                </div>
            }
        }
    </div>
    <div dialog-footer class="footer">
        <button class="modal-btn bt-button" (click)="onLoad();" [disabled]="!selectedForce() && !selectedPack()">LOAD</button>
        <button class="modal-btn bt-button danger" (click)="onDelete();" [disabled]="!selectedForce()">DELETE</button>
        <button class="modal-btn bt-button" (click)="onClose();">DISMISS</button>
    </div>
</base-dialog>