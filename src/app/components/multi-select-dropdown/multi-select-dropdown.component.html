<div class="multi-select-container corner-borders" [class.open]="isOpen()">
    <div class="display-area" (click)="toggleDropdown()">
        <span class="label">{{ label() }}</span>
        <div class="pills-container">
            @if (selectedOptions().length === 0) {
                <span class="placeholder">Any</span>
            }
            @for (option of selectedOptions(); let i = $index; track i) {
                <span class="pill"
                      [ngClass]="{
                        'pill-or': option.state === 'or',
                        'pill-and': option.state === 'and',
                        'pill-not': option.state === 'not'
                      }">
                    {{ option.name }}{{ (option.count > 1) ? ' (' + option.count + ')' : '' }}
                    <button class="remove-pill" (click)="removeOption(option.name, $event)">&#10005;</button>
                </span>
            }
        </div>
        <svg class="chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
        </svg>
    </div>

    @if (isOpen()) {
        <div class="options-dropdown framed-borders">
            @if (options().length > 20) {
                <div class="filter-container" (click)="$event.stopPropagation()">
                    <input 
                        #filterInput
                        type="text" 
                        class="filter-input" 
                        placeholder="Filter..."
                        [value]="filterText()"
                        (input)="onFilterInput($event)">
                </div>
            }
            <div class="options-list">
                @for (option of filteredOptions(); let i = $index; track option.name) {
                    <label class="option-item"
                        [class.unavailable]="option.available === false"
                        [class.selected-single]="!multiselect() && isSelected(option.name)"
                        (click)="!multiselect() ? onSingleSelect(option.name) : null"
                        >
                        @if (multiselect()) {
                            <input type="checkbox" [checked]="isSelected(option.name)" (change)="onOptionToggle(option.name)" />
                            <span class="custom-checkbox"
                                [ngClass]="{
                                    'checkbox-or': multistate() && isSelected(option.name) === 'or',
                                    'checkbox-and': multistate() && isSelected(option.name) === 'and',
                                    'checkbox-not': multistate() && isSelected(option.name) === 'not',
                                    'checked': !multistate() && isSelected(option.name)
                                }">
                                @if (multistate()) {
                                    @switch (isSelected(option.name)) {
                                        @case ('and') {
                                            <span class="checkbox-mark">+</span>
                                        }
                                        @case ('not') {
                                            <span class="checkbox-mark">&#10005;</span>
                                        }
                                        @default {
                                            <span class="checkbox-mark">&#10003;</span>
                                        }
                                    }
                                } @else {
                                    @if (isSelected(option.name)) {
                                        <span class="checkbox-mark">&#10003;</span>
                                    }
                                }
                            </span>
                        }
                        @if (option.img) {
                            <img [src]="option.img" class="option-img" alt="">
                        }
                        <span>{{ option.name }}</span>
                        @if (countable() && (getState(option.name) === 'and' || getState(option.name) === 'or')) {
                            <div class="quantity-input">
                            <input type="number" 
                                    [value]="getCount(option.name)"
                                    min="1"
                                    class="quantity-field"
                                    (input)="onQuantityInput(option.name, $event)"
                                    (click)="$event.stopPropagation()" />
                            </div>
                        }
                    </label>
                }
                @if (filteredOptions().length === 0 && options().length > 0) {
                    <div class="no-options">
                        No matching options
                    </div>
                }
                @if (options().length === 0) {
                    <div class="no-options">
                        No options available
                    </div>
                }
            </div>
        </div>
    }
</div>