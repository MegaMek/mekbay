<div class="dialog-header">
    <h2 class="force-name" [class.clickable]="!isReadOnly()" (click)="onForceNameClick()" [title]="isReadOnly() ? '' : 'Click to rename'">{{ forceName() }}</h2>
    <div class="dialog-header-actions">
        <span class="unit-count">{{ unitCount() }} unit{{ unitCount() !== 1 ? 's' : '' }}</span>
        <span class="force-total">Total {{ isAlphaStrike() ? 'PV' : 'BV' }}: {{ totalBv() | number }}</span>
    </div>
</div>

<div class="dialog-content" #scrollContainer>
    <div class="units-list" 
        id="force-groups"
        [class.compact]="viewMode() === 'compact'" 
        [class.single-group]="hasSingleGroup()" 
        [class.as-table-mode]="isTableMode()"
        cdkDropList 
        [cdkDropListData]="groups()" 
        cdkDropListOrientation="vertical"
        [cdkDropListAutoScrollDisabled]="true"
        [cdkDropListDisabled]="!canDragDrop()"
        (cdkDropListDropped)="dropGroup($event)">
        <!-- Table Header for AS Table View -->
        @if (isTableMode()) {
            <div class="as-table-header">
                <div class="as-th as-th-icon"></div>
                <div class="as-th as-th-name">Name</div>
                <div class="as-th as-th-type">Type</div>
                <div class="as-th as-th-role">Role</div>
                <div class="as-th as-th-pv">PV</div>
                <div class="as-th as-th-skill">Skill</div>
                <div class="as-th as-th-sz">SZ</div>
                <div class="as-th as-th-mv">MV</div>
                <div class="as-th as-th-tmm">TMM</div>
                <div class="as-th as-th-dmg">S/M/L</div>
                <div class="as-th as-th-arm">A</div>
                <div class="as-th as-th-str">S</div>
                <div class="as-th as-th-ov">OV</div>
                @if (asTableSortSlotHeader(); as sortHeader) {
                    <div class="as-th as-th-sort-slot">{{ sortHeader }}</div>
                }
                <div class="as-th as-th-specials">Special</div>
            </div>
        }
        @for (group of groups(); let gi = $index; track group.id) {
            <div class="group-container" cdkDrag
                [cdkDragDisabled]="!canDragDrop() || hasSingleGroup()"
                (cdkDragStarted)="onGroupDragStart()"
                (cdkDragMoved)="onUnitDragMoved($event)"
                (cdkDragEnded)="onGroupDragEnd()"
                cdkDragLockAxis="y"
                [cdkDragStartDelay]="layoutService.isTouchInput() ? 200 : 0">
                @if (!hasSingleGroup()) {
                    <div class="group-header" cdkDragHandle>
                        <div class="group-name" [class.clickable]="!isReadOnly()" 
                            (click)="onGroupNameClick(group)" 
                            [title]="isReadOnly() ? '' : 'Click to rename'">{{ group.name() }}</div>
                        <div class="group-footer">
                            <span class="group-bv">{{ isAlphaStrike() ? 'PV' : 'BV' }}: {{ group.totalBV() | number }}</span>

                        </div>
                    </div>
                }
                @let units = group.units();
                <div class="group-units"
                    cdkDropList 
                    id="group-{{ group.id }}"
                    cdkDropListOrientation="mixed"
                    [cdkDropListData]="units"
                    [cdkDropListConnectedTo]="connectedDropLists()"
                    [cdkDropListDisabled]="!canDragDrop()"
                    [cdkDropListAutoScrollDisabled]="true"
                    (cdkDropListDropped)="drop($event)">
                    @if (viewMode() === 'compact' && units.length === 0) {
                        <div class="empty-group-placeholder" (click)="onEmptyGroupClick(group)">
                            No units in this group. Drop units here or click to remove.
                        </div>
                    }
                    @if (viewMode() === 'compact') {
                        @for (forceUnit of units; let last = $last; track forceUnit.id) {
                            <div class="drag-item" 
                                cdkDrag
                                cdkDragPreviewClass="glass"
                                [cdkDragDisabled]="!canDragDrop()"
                                (cdkDragStarted)="onUnitDragStart()"
                                (cdkDragMoved)="onUnitDragMoved($event)"
                                (cdkDragEnded)="onUnitDragEnd()"
                                [cdkDragStartDelay]="layoutService.isTouchInput() ? 200 : 0">
                                <unit-block
                                    [forceUnit]="forceUnit"
                                    [compactMode]="false"
                                    (onEditPilot)="onPilotClick(forceUnit)"
                                    (onOpenC3Network)="openC3Network($event, forceUnit)"
                                    (onRemoveUnit)="removeUnit($event, forceUnit)"
                                    (onRepairUnit)="repairUnit($event, forceUnit)"
                                    (onInfo)="showUnitInfo($event, forceUnit)">
                                </unit-block>
                            </div>
                        }
                    } @else {
                        @for (vm of getSortedUnitsForGroup(group); let last = $last; track vm.forceUnit.id) {
                            @if (isTableMode()) {
                                <!-- AS Table Row View -->
                                <div class="as-table-row" (click)="onUnitClick(vm)">
                                    <div class="as-td as-td-icon"><unit-icon [unit]="vm.unit" [size]="36"></unit-icon></div>
                                    <div class="as-td as-td-name">
                                        <span class="as-td-model">{{ vm.unit.model }}</span>
                                        <span class="as-td-chassis">{{ vm.unit.chassis }}@if (vm.forceUnit.alias(); as alias) { <span class="as-td-alias">({{ alias }})</span>}</span>
                                    </div>
                                    <div class="as-td as-td-type" [class.sort-slot]="isSortActive('as.TP')">{{ vm.unit.as.TP }}</div>
                                    <div class="as-td as-td-role" [class.sort-slot]="isSortActive('role')">{{ vm.unit.role !== 'None' ? vm.unit.role : '' }}</div>
                                    <div class="as-td as-td-pv" [class.sort-slot]="isSortActive('as.PV')">{{ vm.unit.as.PV | adjustedPV:getPilotSkill(vm) | formatNumber:true:false }}</div>
                                    <div class="as-td as-td-skill clickable" (click)="onPilotClick(vm.forceUnit); $event.stopPropagation()" title="Click to edit pilot">{{ getPilotSkill(vm) }}</div>
                                    <div class="as-td as-td-sz" [class.sort-slot]="isSortActive('as.SZ')">{{ vm.unit.as.SZ }}</div>
                                    <div class="as-td as-td-mv" [class.sort-slot]="isSortActive('as._mv')" [innerHTML]="formatASMovement(vm.unit)"></div>
                                    <div class="as-td as-td-tmm" [class.sort-slot]="isSortActive('as.TMM')">{{ vm.unit.as.TMM }}</div>
                                    <div class="as-td as-td-dmg" [class.sort-slot]="isSortActive('as.damage')">@if (!vm.unit.as.usesArcs) { {{ vm.unit.as.dmg.dmgS }}/{{ vm.unit.as.dmg.dmgM }}/{{ vm.unit.as.dmg.dmgL }} }</div>
                                    <div class="as-td as-td-arm" [class.sort-slot]="isSortActive('as.Arm')">{{ vm.unit.as.Arm }}</div>
                                    <div class="as-td as-td-str" [class.sort-slot]="isSortActive('as.Str')">{{ vm.unit.as.Str }}</div>
                                    <div class="as-td as-td-ov" [class.sort-slot]="isSortActive('as.OV')">@if (vm.unit.as.usesOV) { {{ vm.unit.as.OV }} }</div>
                                    @if (getAsTableSortSlot(vm); as sortValue) {
                                        <div class="as-td as-td-sort-slot sort-slot">{{ sortValue }}</div>
                                    }
                                    <div class="as-td as-td-specials">
                                        @for (special of vm.unit.as.specials; let i = $index; track i) {
                                            <span class="special-pill" (click)="showAbilityInfoDialog(special); $event.stopPropagation()" title="Click for details">{{ special }}</span>
                                        }
                                    </div>
                                </div>
                            } @else {
                                <!-- Expanded Card View (AS or BT) -->
                                <unit-card-expanded
                                    [unit]="vm.forceUnit"
                                    [expandedView]="true"
                                    [sortKey]="selectedSort()"
                                    [sortSlotLabel]="selectedSortLabel()"
                                    [useHex]="useHex()"
                                    (cardClick)="onUnitClick(vm)"
                                    (tagClick)="onTagClick($event)"
                                    (pilotClick)="onPilotClick($event)">
                                </unit-card-expanded>
                            }
                            @if (!last && !isTableMode()) {
                                <hr class="divider" />
                            }
                        }
                    }
                </div>
            </div>
        }
        @if (canDragDrop() && !hasMaxGroups()) {
            <div #newGroupDropzone class="group-container new-group-dropzone" 
                cdkDropList 
                id="new-group-dropzone"
                [cdkDropListData]="[]"
                [cdkDropListConnectedTo]="connectedDropLists()"
                [cdkDropListAutoScrollDisabled]="true"
                [class.visible]="isUnitDragging() && !isGroupDragging() && !hasEmptyGroups()"
                (cdkDropListDropped)="dropForNewGroup($event)">
                <div class="new-group-placeholder">Drop units here to form a new group</div>
            </div>
        }
    </div>
</div>

<div class="dialog-footer">
    <div class="sort-controls">
        <select class="bt-input sort-select"
            (change)="setSortOrder($any($event.target).value)">
            @for (opt of SORT_OPTIONS; let i = $index; track i) {
                @if (!opt.gameSystem || opt.gameSystem === gameSystem()) {
                    <option [value]="opt.key" [selected]="opt.key === selectedSort()">{{ opt.label }}</option>
                }
            }
        </select>
        <button type="button" class="bt-button sort-direction-btn"
            (click)="setSortDirection(selectedSortDirection() === 'asc' ? 'desc' : 'asc')"
            [title]="selectedSortDirection() === 'asc' ? 'Ascending' : 'Descending'"
            [attr.aria-label]="selectedSortDirection() === 'asc' ? 'Ascending' : 'Descending'">
            @if (selectedSortDirection() === 'asc') {
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" focusable="false"
                    aria-hidden="true" role="img">
                    <path d="M4 16L13 16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                    <path d="M6 11H13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                    <path d="M8 6L13 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                    <path d="M17 4L17 20L20 16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
            } @else {
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" focusable="false"
                    aria-hidden="true" role="img">
                    <path d="M4 8H13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                    <path d="M6 13H13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                    <path d="M8 18H13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                    <path d="M17 20V4L20 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
            }
        </button>
    </div>
    <button type="button" class="bt-button view-toggle-btn" (click)="toggleViewMode()" 
        [title]="viewMode() === 'expanded' ? 'Switch to compact view' : 'Switch to expanded view'">
        @if (viewMode() === 'expanded') {
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7" rx="1"/>
                <rect x="14" y="3" width="7" height="7" rx="1"/>
                <rect x="3" y="14" width="7" height="7" rx="1"/>
                <rect x="14" y="14" width="7" height="7" rx="1"/>
            </svg>
        } @else {
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="6" rx="1"/>
                <rect x="3" y="14" width="18" height="6" rx="1"/>
            </svg>
        }
    </button>
    <div class="spanner"></div>
    <button class="modal-btn bt-button" (click)="close()">DISMISS</button>
</div>
