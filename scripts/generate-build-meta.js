const fs = require('fs');
const path = require('path');
const child = require('child_process');

const root = path.resolve(__dirname, '..'); // app/ folder
const versionFile = path.join(root, 'src', 'app', 'version.constant.ts');
const buildMetaFile = path.join(root, 'src', 'app', 'build-meta.ts');

function readVersion() {
  const content = fs.readFileSync(versionFile, 'utf8');
  const m = content.match(/export\s+const\s+APP_VERSION\s*=\s*['"]([^'"]+)['"]/);
  return m ? m[1] : '0.0';
}

function git(cmd) {
  try {
    return child.execSync(cmd, { cwd: root, encoding: 'utf8' }).trim();
  } catch {
    return null;
  }
}

function detectBranch() {
  // Prefer GitHub Actions ref if available
  const ghRef = process.env.GITHUB_REF;
  if (ghRef) {
    // refs/heads/main -> main
    const m = ghRef.match(/^refs\/heads\/(.+)$/);
    if (m) return m[1];
    return ghRef;
  }

  // Fallback to git
  const branch = git('git rev-parse --abbrev-ref HEAD');
  return branch || 'unknown';
}

function writeBuildMeta(version, commitNumber, commitHash, branch, timestamp) {
  const versionString = `${version}.${commitNumber} (${branch}/${commitHash}) ${timestamp}`;
  const content = `// Auto-generated by scripts/generate-build-meta.js - do not edit
export const APP_VERSION = '${version}';
export const BUILD_COMMIT_NUMBER = ${commitNumber};
export const BUILD_COMMIT_HASH = '${commitHash}';
export const BUILD_BRANCH = '${branch}';
export const BUILD_TIMESTAMP = '${timestamp}';
export const APP_VERSION_STRING = '${versionString}';
`;
  fs.writeFileSync(buildMetaFile, content, 'utf8');
  return versionString;
}

(function main() {
  try {
    const version = readVersion();

    // commit count (number of commits reachable from HEAD)
    // TODO: reimplement it with an API call to GitHub so we don't have to use depth: 0 in checkout
    const commitNumber = parseInt(git('git rev-list --count HEAD') || '0', 10);

    // short commit hash
    const commitHash = git('git rev-parse --short HEAD') || 'unknown';
    const branch = detectBranch();

    const timestamp = new Date().toISOString();

    const generated = writeBuildMeta(version, commitNumber || 0, commitHash, branch, timestamp);
    console.log('Build meta generated:', generated);
  } catch (err) {
    console.error('Failed to generate build meta:', err);
    process.exitCode = 1;
  }
})();